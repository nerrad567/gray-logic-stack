<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KNXSim</title>
    <link rel="stylesheet" href="css/style.css?v=11" />
    <!-- Load app.js first to register stores, then Alpine -->
    <script type="module">
      import { initStores, startApp } from "./js/app.js";

      // Register stores before Alpine starts
      document.addEventListener("alpine:init", () => {
        initStores();
      });

      // Start app after Alpine is ready
      document.addEventListener("alpine:initialized", () => {
        startApp();
      });
    </script>
    <script defer src="js/vendor/alpine-collapse.min.js"></script>
    <script defer src="js/vendor/alpine-intersect.min.js"></script>
    <script defer src="js/vendor/alpine.min.js"></script>
  </head>
  <body x-data x-cloak>
    <div id="app">
      <!-- Header -->
      <header class="header">
        <div class="header-left">
          <h1 class="logo">
            <img
              src="img/knxsim.svg"
              alt="Gray Logic KNXSim"
              class="logo-img"
            />
          </h1>
          <label for="premise-select" class="visually-hidden"
            >Select Premise</label
          >
          <select
            id="premise-select"
            name="premise-select"
            class="premise-select"
            x-model="$store.app.currentPremiseId"
            @change="$store.app.selectPremise($event.target.value)"
          >
            <template x-if="$store.app.premises.length === 0">
              <option value="">Loading...</option>
            </template>
            <template x-for="premise in $store.app.premises" :key="premise.id">
              <option :value="premise.id" x-text="premise.name"></option>
            </template>
          </select>
        </div>
        <div class="header-right">
          <span
            class="status"
            :class="{
                          'connected': $store.app.connected,
                          'connecting': $store.app.connecting,
                          'disconnected': !$store.app.connected && !$store.app.connecting
                      }"
          >
            <span class="status-dot"></span>
            <span
              class="status-text"
              x-text="$store.app.connected ? 'Connected' : ($store.app.connecting ? 'Connecting...' : 'Disconnected')"
            ></span>
          </span>
          <button
            class="btn btn-engineer"
            :class="{ 'active': $store.app.engineerMode }"
            @click="$store.app.toggleEngineerMode()"
          >
            Edit Mode
          </button>
          <!-- Export dropdown (Engineer Mode only) -->
          <div
            class="export-dropdown"
            x-show="$store.app.engineerMode"
            x-data="{ open: false }"
          >
            <button
              class="btn btn-export"
              @click="open = !open"
              @click.outside="open = false"
            >
              üì• Export
            </button>
            <div class="export-menu" x-show="open" x-transition>
              <a
                :href="`/api/v1/premises/${$store.app.currentPremiseId}/export/knxproj`"
                class="export-item"
                download
                @click="open = false"
              >
                <span class="export-icon">üì¶</span>
                <span class="export-label">ETS Project (.knxproj)</span>
              </a>
              <a
                :href="`/api/v1/premises/${$store.app.currentPremiseId}/export/esf`"
                class="export-item"
                download
                @click="open = false"
              >
                <span class="export-icon">üìÑ</span>
                <span class="export-label">Symbol File (.esf)</span>
              </a>
            </div>
          </div>
        </div>
      </header>

      <!-- View Switcher -->
      <nav class="view-switcher">
        <button
          class="view-tab"
          :class="{ 'active': $store.app.viewMode === 'building' }"
          @click="$store.app.switchView('building')"
        >
          üè† Building View
        </button>
        <button
          class="view-tab"
          :class="{ 'active': $store.app.viewMode === 'topology' }"
          @click="$store.app.switchView('topology')"
        >
          üîå Topology View
        </button>
        <button
          class="view-tab"
          :class="{ 'active': $store.app.viewMode === 'groups' }"
          @click="$store.app.switchView('groups')"
        >
          üìã Group Addresses
        </button>
      </nav>

      <!-- Floor Navigation (Building View only) -->
      <nav class="floor-nav" x-show="$store.app.viewMode === 'building'">
        <div class="floor-tabs">
          <!-- Floor tabs -->
          <template x-for="floor in $store.app.floors" :key="floor.id">
            <div
              class="floor-tab-wrapper"
              :class="{ 'active': floor.id === $store.app.currentFloorId }"
            >
              <button
                class="floor-tab"
                :class="{ 'active': floor.id === $store.app.currentFloorId }"
                @click="$store.app.selectFloor(floor.id)"
                x-text="floor.name"
              ></button>
              <!-- Edit/Delete buttons (Engineer Mode) -->
              <div class="floor-tab-actions" x-show="$store.app.engineerMode">
                <button
                  class="btn-icon"
                  @click.stop="$store.modal.show('floor', 'edit', floor)"
                  title="Edit floor"
                >
                  ‚úèÔ∏è
                </button>
                <button
                  class="btn-icon btn-danger"
                  @click.stop="$store.modal.confirm('Delete Floor', `Delete '${floor.name}' and all its rooms?`, () => $store.app.deleteFloor(floor.id))"
                  title="Delete floor"
                >
                  üóëÔ∏è
                </button>
              </div>
            </div>
          </template>

          <!-- Add floor button (Engineer Mode) -->
          <button
            class="floor-tab floor-tab-add"
            x-show="$store.app.engineerMode"
            @click="$store.modal.show('floor', 'create')"
            title="Add floor"
          >
            +
          </button>

          <!-- No floors message -->
          <span
            class="floor-tab-empty"
            x-show="$store.app.floors.length === 0 && !$store.app.engineerMode"
          >
            No floors configured
          </span>
        </div>
      </nav>

      <!-- Main Content -->
      <main class="main-content">
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <!-- TOPOLOGY VIEW -->
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <section class="topology-view" x-show="$store.app.viewMode === 'topology'">
          <!-- Loading state -->
          <div class="loading-placeholder" x-show="!$store.app.topology">
            <p>Loading topology...</p>
          </div>

          <!-- Topology tree -->
          <div class="topology-tree" x-show="$store.app.topology">
            <!-- Add Area button (Engineer Mode) -->
            <div class="topology-actions" x-show="$store.app.engineerMode">
              <button
                class="btn btn-primary"
                @click="$store.modal.show('area', 'create')"
              >
                + Add Area
              </button>
            </div>

            <!-- Empty state -->
            <div
              class="topology-empty"
              x-show="$store.app.topology?.areas?.length === 0"
            >
              <p>No areas configured. Add an area to organize your KNX topology.</p>
            </div>

            <!-- Areas -->
            <template x-for="area in $store.app.topology?.areas || []" :key="area.id">
              <div class="topology-area">
                <div
                  class="topology-area-header"
                  @click="$store.app.toggleArea(area.id)"
                >
                  <span class="topology-expand-icon" x-text="$store.app.isAreaExpanded(area.id) ? '‚ñº' : '‚ñ∂'"></span>
                  <span class="topology-area-number" x-text="'Area ' + area.area_number"></span>
                  <span class="topology-area-name" x-text="area.name"></span>
                  <span class="topology-area-count" x-text="area.lines?.length + ' line(s)'"></span>
                  <!-- Area actions (Engineer Mode) -->
                  <div class="topology-actions-inline" x-show="$store.app.engineerMode" @click.stop>
                    <button
                      class="btn-icon"
                      @click="$store.modal.show('line', 'create', { area_id: area.id, area_number: area.area_number })"
                      title="Add line"
                    >
                      ‚ûï
                    </button>
                    <button
                      class="btn-icon"
                      @click="$store.modal.show('area', 'edit', area)"
                      title="Edit area"
                    >
                      ‚úèÔ∏è
                    </button>
                    <button
                      class="btn-icon btn-danger"
                      @click="$store.modal.confirm('Delete Area', `Delete '${area.name}' and all its lines?`, () => $store.app.deleteArea(area.id))"
                      title="Delete area"
                    >
                      üóëÔ∏è
                    </button>
                  </div>
                </div>

                <!-- Lines (collapsible) -->
                <div class="topology-lines" x-show="$store.app.isAreaExpanded(area.id)" x-collapse>
                  <template x-for="line in area.lines || []" :key="line.id">
                    <div class="topology-line">
                      <div
                        class="topology-line-header"
                        @click="$store.app.toggleLine(line.id)"
                      >
                        <span class="topology-expand-icon" x-text="$store.app.isLineExpanded(line.id) ? '‚ñº' : '‚ñ∂'"></span>
                        <span class="topology-line-number" x-text="area.area_number + '.' + line.line_number"></span>
                        <span class="topology-line-name" x-text="line.name"></span>
                        <span class="topology-line-count" x-text="line.devices?.length + ' device(s)'"></span>
                        <!-- Line actions (Engineer Mode) -->
                        <div class="topology-actions-inline" x-show="$store.app.engineerMode" @click.stop>
                          <button
                            class="btn-icon"
                            @click="$store.modal.show('device', 'create', { line_id: line.id, suggested_ia: area.area_number + '.' + line.line_number + '.' + $store.app.getNextDeviceNumber(line.id) })"
                            title="Add device"
                          >
                            ‚ûï
                          </button>
                          <button
                            class="btn-icon"
                            @click="$store.modal.show('line', 'edit', { ...line, area_id: area.id, area_number: area.area_number })"
                            title="Edit line"
                          >
                            ‚úèÔ∏è
                          </button>
                          <button
                            class="btn-icon btn-danger"
                            @click="$store.modal.confirm('Delete Line', `Delete '${line.name}'? Devices will become unlinked.`, () => $store.app.deleteLine(area.id, line.id))"
                            title="Delete line"
                          >
                            üóëÔ∏è
                          </button>
                        </div>
                      </div>

                      <!-- Devices on this line (collapsible) -->
                      <div class="topology-devices" x-show="$store.app.isLineExpanded(line.id)" x-collapse>
                        <template x-for="device in line.devices || []" :key="device.id">
                          <div
                            class="topology-device"
                            :class="{ 'selected': device.id === $store.app.selectedDeviceId }"
                            @click="$store.app.selectDevice(device.id)"
                          >
                            <span class="topology-device-addr" x-text="device.individual_address"></span>
                            <span class="topology-device-icon" x-text="$store.app.getDeviceIcon(device.type)"></span>
                            <span class="topology-device-name" x-text="device.id"></span>
                            <span class="topology-device-type" x-text="device.type"></span>
                            <span class="topology-device-room" x-show="device.room_id" x-text="'üìç ' + device.room_id"></span>
                          </div>
                        </template>

                        <!-- Empty line -->
                        <div class="topology-empty-line" x-show="!line.devices?.length">
                          <span>No devices on this line</span>
                          <button
                            class="btn btn-small"
                            x-show="$store.app.engineerMode"
                            @click="$store.modal.show('device', 'create', { line_id: line.id, suggested_ia: area.area_number + '.' + line.line_number + '.1' })"
                          >
                            + Add Device
                          </button>
                        </div>
                      </div>
                    </div>
                  </template>

                  <!-- Empty area -->
                  <div class="topology-empty-area" x-show="!area.lines?.length">
                    <span>No lines in this area</span>
                    <button
                      class="btn btn-small"
                      x-show="$store.app.engineerMode"
                      @click="$store.modal.show('line', 'create', { area_id: area.id, area_number: area.area_number })"
                    >
                      + Add Line
                    </button>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </section>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <!-- GROUPS VIEW (Group Address Hierarchy) -->
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <section class="groups-view" x-show="$store.app.viewMode === 'groups'">
          <!-- Loading state -->
          <div class="loading-placeholder" x-show="$store.groups.loading">
            <p>Loading group addresses...</p>
          </div>

          <!-- Groups tree -->
          <div class="groups-tree" x-show="!$store.groups.loading">
            <!-- Create Defaults button (Engineer Mode, no groups yet) -->
            <div class="groups-actions" x-show="$store.app.engineerMode">
              <div class="dropdown" x-data="{ open: false }" x-show="$store.groups.mainGroups.length === 0">
                <button
                  class="btn btn-primary"
                  @click="open = !open"
                  @click.away="open = false"
                >
                  üîß Create Default Structure ‚ñæ
                </button>
                <div class="dropdown-menu" x-show="open" x-transition>
                  <button
                    class="dropdown-item"
                    @click="$store.groups.createDefaults($store.app.currentPremiseId, 'residential'); open = false"
                  >
                    <strong>Residential / Intuitive</strong>
                    <small>Function-based: Lighting, Blinds, HVAC...</small>
                  </button>
                  <button
                    class="dropdown-item"
                    @click="$store.groups.createDefaults($store.app.currentPremiseId, 'small_commercial'); open = false"
                  >
                    <strong>Small/Medium Commercial</strong>
                    <small>Location-based: Floor 1, Floor 2...</small>
                  </button>
                </div>
              </div>
              <button
                class="btn btn-primary"
                @click="$store.modal.show('mainGroup', 'create')"
              >
                + Add Main Group
              </button>
            </div>

            <!-- Empty state -->
            <div
              class="groups-empty"
              x-show="$store.groups.mainGroups.length === 0 && !$store.groups.loading"
            >
              <p>No group address structure defined.</p>
              <p x-show="$store.app.engineerMode">Click "Create Default Structure" to generate a standard KNX layout.</p>
            </div>

            <!-- Main Groups -->
            <template x-for="mainGroup in $store.groups.mainGroups" :key="mainGroup.id">
              <div class="groups-main-group">
                <div
                  class="groups-main-header"
                  @click="$store.groups.toggleMainGroup(mainGroup.id)"
                >
                  <span class="groups-expand-icon" x-text="$store.groups.isMainGroupExpanded(mainGroup.id) ? '‚ñº' : '‚ñ∂'"></span>
                  <span class="groups-main-number" x-text="mainGroup.group_number"></span>
                  <span class="groups-main-name" x-text="mainGroup.name"></span>
                  <span class="groups-main-count" x-text="(mainGroup.middle_groups?.length || 0) + ' middle group(s)'"></span>
                  <!-- Main Group actions (Engineer Mode) -->
                  <div class="groups-actions-inline" x-show="$store.app.engineerMode" @click.stop>
                    <button
                      class="btn-icon"
                      @click="$store.modal.show('middleGroup', 'create', { main_group_id: mainGroup.id, main_group_number: mainGroup.group_number })"
                      title="Add middle group"
                    >
                      ‚ûï
                    </button>
                    <button
                      class="btn-icon"
                      @click="$store.modal.show('mainGroup', 'edit', mainGroup)"
                      title="Edit main group"
                    >
                      ‚úèÔ∏è
                    </button>
                    <button
                      class="btn-icon btn-danger"
                      @click="$store.modal.confirm('Delete Main Group', `Delete '${mainGroup.name}' and all its middle groups?`, () => $store.groups.deleteMainGroup(mainGroup.id))"
                      title="Delete main group"
                    >
                      üóëÔ∏è
                    </button>
                  </div>
                </div>

                <!-- Middle Groups (collapsed by default) -->
                <div class="groups-middle-list" x-show="$store.groups.isMainGroupExpanded(mainGroup.id)" x-collapse>
                  <!-- Empty middle groups -->
                  <div
                    class="groups-empty-middle"
                    x-show="!mainGroup.middle_groups || mainGroup.middle_groups.length === 0"
                  >
                    <p>No middle groups. <span x-show="$store.app.engineerMode">Click ‚ûï to add one.</span></p>
                  </div>

                  <template x-for="middleGroup in mainGroup.middle_groups || []" :key="middleGroup.id">
                    <div class="groups-middle-group">
                      <div
                        class="groups-middle-header"
                        @click="$store.groups.toggleMiddleGroup(middleGroup.id)"
                      >
                        <span class="groups-expand-icon" x-text="$store.groups.isMiddleGroupExpanded(middleGroup.id) ? '‚ñº' : '‚ñ∂'"></span>
                        <span class="groups-middle-number" x-text="mainGroup.group_number + '/' + middleGroup.group_number"></span>
                        <span class="groups-middle-name" x-text="middleGroup.name"></span>
                        <span class="groups-middle-floor" x-show="middleGroup.floor_id">
                          üìç <span x-text="$store.app.floors.find(f => f.id === middleGroup.floor_id)?.name || ''"></span>
                        </span>
                        <!-- Middle Group actions (Engineer Mode) -->
                        <div class="groups-actions-inline" x-show="$store.app.engineerMode" @click.stop>
                          <button
                            class="btn-icon"
                            @click="$store.modal.show('middleGroup', 'edit', { ...middleGroup, main_group_number: mainGroup.group_number })"
                            title="Edit middle group"
                          >
                            ‚úèÔ∏è
                          </button>
                          <button
                            class="btn-icon btn-danger"
                            @click="$store.modal.confirm('Delete Middle Group', `Delete '${middleGroup.name}'?`, () => $store.groups.deleteMiddleGroup(middleGroup.id))"
                            title="Delete middle group"
                          >
                            üóëÔ∏è
                          </button>
                        </div>
                      </div>

                      <!-- GAs in this middle group (collapsed by default) -->
                      <div class="groups-ga-list" x-show="$store.groups.isMiddleGroupExpanded(middleGroup.id)" x-collapse>
                        <template x-for="gaInfo in $store.groups.getGAsInGroup(mainGroup.group_number, middleGroup.group_number)" :key="gaInfo.ga + gaInfo.device.id + gaInfo.function">
                          <div class="groups-ga-row">
                            <span class="groups-ga-address mono" x-text="gaInfo.ga"></span>
                            <span class="groups-ga-function" x-text="gaInfo.function"></span>
                            <span class="groups-ga-device" x-text="gaInfo.device.id"></span>
                            <span class="groups-ga-dpt mono" x-text="gaInfo.dpt || '-'"></span>
                          </div>
                        </template>
                        <div
                          class="groups-ga-empty"
                          x-show="$store.groups.getGAsInGroup(mainGroup.group_number, middleGroup.group_number).length === 0"
                        >
                          <p>No group addresses assigned in this range.</p>
                        </div>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </template>
          </div>
        </section>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <!-- BUILDING VIEW -->
        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <section class="building-view" x-show="$store.app.viewMode === 'building'">
          <!-- Floor Plan Layer (future) -->
          <div
            id="floor-plan-layer"
            class="floor-plan-layer"
            x-show="$store.app.floorPlanMode && $store.app.currentFloor?.plan_image"
          >
            <img
              :src="$store.app.currentFloor?.plan_image"
              class="floor-plan-image"
              alt="Floor plan"
            />
            <!-- Device markers will be positioned here -->
          </div>

          <!-- Room Grid -->
          <div class="room-grid" x-show="!$store.app.floorPlanMode">
          <!-- No devices placeholder -->
          <div
            class="loading-placeholder"
            x-show="$store.app.roomsWithDevices.length === 0 && !$store.app.engineerMode"
          >
            <p>No devices found</p>
          </div>

          <!-- Room cards -->
          <template x-for="room in $store.app.roomsWithDevices" :key="room.id">
            <div
              class="room-card"
              :data-room-id="room.id"
              :class="{ 'drag-over': $store.app.dragOverRoomId === room.id }"
              @dragover.prevent="$store.app.engineerMode && ($store.app.dragOverRoomId = room.id)"
              @dragleave="$store.app.dragOverRoomId = null"
              @drop="$store.app.engineerMode && $store.app.dropDeviceOnRoom($event, room.id === '_unassigned' ? null : room.id)"
            >
              <div class="room-header">
                <span class="room-name" x-text="room.name"></span>
                <div class="room-header-right">
                  <span
                    class="room-status"
                    x-text="$store.app.getRoomStatusSummary(room.devices)"
                  ></span>
                  <!-- Room edit/delete (Engineer Mode, not for unassigned) -->
                  <template
                    x-if="$store.app.engineerMode && room.id !== '_unassigned'"
                  >
                    <div class="room-actions">
                      <button
                        class="btn-icon"
                        @click="$store.modal.show('room', 'edit', { ...room, floor_id: $store.app.currentFloorId })"
                        title="Edit room"
                      >
                        ‚úèÔ∏è
                      </button>
                      <button
                        class="btn-icon btn-danger"
                        @click="$store.modal.confirm('Delete Room', `Delete '${room.name}'? Devices will become unassigned.`, () => $store.app.deleteRoom($store.app.currentFloorId, room.id))"
                        title="Delete room"
                      >
                        üóëÔ∏è
                      </button>
                    </div>
                  </template>
                </div>
              </div>
              <div class="room-devices">
                <!-- Device tiles -->
                <template x-for="device in room.devices" :key="device.id">
                  <div
                    class="device-tile"
                    :class="{ 'selected': device.id === $store.app.selectedDeviceId, 'dragging': $store.app.draggingDeviceId === device.id }"
                    :draggable="$store.app.engineerMode"
                    @click="$store.app.selectDevice(device.id)"
                    @dragstart="$store.app.engineerMode && $store.app.startDragDevice($event, device.id)"
                    @dragend="$store.app.endDragDevice()"
                  >
                    <div class="device-info">
                      <span
                        class="device-icon"
                        x-text="$store.app.getDeviceIcon(device.type)"
                      ></span>
                      <span
                        class="device-name"
                        x-text="$store.app.formatDeviceName(device.id)"
                      ></span>
                    </div>
                    <div class="device-state">
                      <template
                        x-if="$store.app.getStateDisplay(device).indicator !== null"
                      >
                        <span
                          class="state-indicator"
                          :class="{ 'on': $store.app.getStateDisplay(device).indicator }"
                        ></span>
                      </template>
                      <span
                        class="state-value"
                        x-text="$store.app.getStateDisplay(device).value"
                      ></span>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </template>

          <!-- Add Room card (Engineer Mode) -->
          <div
            class="room-card room-card-add"
            x-show="$store.app.engineerMode && $store.app.currentFloorId"
            @click="$store.modal.show('room', 'create', { floor_id: $store.app.currentFloorId })"
          >
            <div class="add-card-content">
              <span class="add-icon">+</span>
              <span class="add-label">Add Room</span>
            </div>
          </div>
        </div>
        </section>

        <!-- Device Detail Panel (Engineer Mode) -->
        <aside
          class="device-panel"
          :class="{ 'hidden': !$store.app.engineerMode || !$store.app.selectedDevice }"
        >
          <template x-if="$store.app.selectedDevice">
            <div>
              <div class="panel-header">
                <h3
                  x-text="$store.app.formatDeviceName($store.app.selectedDevice.id)"
                ></h3>
                <button class="btn-close" @click="$store.app.clearSelection()">
                  &times;
                </button>
              </div>
              <div class="panel-content">
                <!-- Device Info -->
                <div class="detail-section">
                  <h4>Address</h4>
                  <div class="detail-row">
                    <span class="label">Type:</span>
                    <span
                      class="value"
                      x-text="$store.app.selectedDevice.type"
                    ></span>
                  </div>
                  <div class="detail-row">
                    <span class="label">Individual:</span>
                    <span
                      class="value mono"
                      x-text="$store.app.selectedDevice.individual_address || '-'"
                    ></span>
                  </div>
                </div>

                <!-- Group Addresses -->
                <div class="detail-section">
                  <h4>Group Addresses</h4>
                  <div class="ga-table-wrapper">
                    <table class="ga-table">
                      <thead>
                        <tr>
                          <th class="ga-col-name">Name</th>
                          <th class="ga-col-ga">GA</th>
                          <th class="ga-col-dpt">DPT</th>
                          <th class="ga-col-flags">Flags</th>
                        </tr>
                      </thead>
                      <tbody>
                        <template
                          x-if="Object.keys($store.app.selectedDevice.group_addresses || {}).length === 0"
                        >
                          <tr>
                            <td colspan="4" class="ga-empty">
                              No group addresses
                            </td>
                          </tr>
                        </template>
                        <template
                          x-for="[name, gaData] in Object.entries($store.app.selectedDevice.group_addresses || {})"
                          :key="name"
                        >
                          <tr>
                            <td class="ga-col-name" x-text="name"></td>
                            <td
                              class="ga-col-ga mono"
                              x-text="typeof gaData === 'object' ? gaData.ga : gaData"
                            ></td>
                            <td
                              class="ga-col-dpt"
                              x-text="typeof gaData === 'object' && gaData.dpt ? gaData.dpt : $store.app.guessDPT(name, $store.app.selectedDevice.type)"
                            ></td>
                            <td class="ga-col-flags">
                              <span
                                class="flags-display"
                                x-text="typeof gaData === 'object' && gaData.flags ? gaData.flags : $store.app.guessFlags(name)"
                                :title="$store.app.getFlagsTooltip(typeof gaData === 'object' && gaData.flags ? gaData.flags : $store.app.guessFlags(name))"
                              ></span>
                            </td>
                          </tr>
                        </template>
                      </tbody>
                    </table>
                  </div>
                  <div class="flags-legend">
                    <small
                      >C=Communicate R=Read W=Write T=Transmit U=Update
                      I=Init</small
                    >
                  </div>
                </div>

                <!-- Current State -->
                <div class="detail-section">
                  <h4>Current State</h4>
                  <pre
                    class="state-display"
                    x-text="JSON.stringify($store.app.selectedDevice.state || {}, null, 2)"
                  ></pre>
                </div>

                <!-- Controls -->
                <div class="detail-section">
                  <h4>Controls</h4>
                  <div class="controls" x-data="deviceControls()">
                    <!-- Light controls -->
                    <template
                      x-if="$store.app.selectedDevice.type.startsWith('light_')"
                    >
                      <div>
                        <div class="control-row">
                          <span class="control-label">Power</span>
                          <button
                            class="toggle-btn"
                            :class="{ 'on': $store.app.selectedDevice.state?.on }"
                            @click="$store.app.sendCommand($store.app.selectedDeviceId, 'switch', !$store.app.selectedDevice.state?.on)"
                          >
                            <span
                              x-text="$store.app.selectedDevice.state?.on ? 'ON' : 'OFF'"
                            ></span>
                          </button>
                        </div>
                        <template
                          x-if="['light_dimmer', 'light_rgb', 'light_colour_temp'].includes($store.app.selectedDevice.type)"
                        >
                          <div class="control-row">
                            <span class="control-label">Brightness</span>
                            <div class="slider-control">
                              <input
                                type="range"
                                class="slider"
                                min="0"
                                max="100"
                                :value="$store.app.selectedDevice.state?.brightness ?? 0"
                                @change="$store.app.sendCommand($store.app.selectedDeviceId, 'brightness', parseInt($event.target.value))"
                              />
                              <span
                                class="slider-value"
                                x-text="($store.app.selectedDevice.state?.brightness ?? 0) + '%'"
                              ></span>
                            </div>
                          </div>
                        </template>
                      </div>
                    </template>

                    <!-- Blind controls -->
                    <template
                      x-if="$store.app.selectedDevice.type.startsWith('blind')"
                    >
                      <div>
                        <div class="control-row">
                          <span class="control-label">Position</span>
                          <div class="slider-control">
                            <input
                              type="range"
                              class="slider"
                              min="0"
                              max="100"
                              :value="$store.app.selectedDevice.state?.position ?? 0"
                              @change="$store.app.sendCommand($store.app.selectedDeviceId, 'position', parseInt($event.target.value))"
                            />
                            <span
                              class="slider-value"
                              x-text="($store.app.selectedDevice.state?.position ?? 0) + '%'"
                            ></span>
                          </div>
                        </div>
                        <template
                          x-if="$store.app.selectedDevice.state?.tilt !== undefined || $store.app.selectedDevice.type === 'blind_position_slat'"
                        >
                          <div class="control-row">
                            <span class="control-label">Slat Angle</span>
                            <div class="slider-control">
                              <input
                                type="range"
                                class="slider"
                                min="0"
                                max="100"
                                :value="$store.app.selectedDevice.state?.tilt ?? 0"
                                @change="$store.app.sendCommand($store.app.selectedDeviceId, 'slat', parseInt($event.target.value))"
                              />
                              <span
                                class="slider-value"
                                x-text="($store.app.selectedDevice.state?.tilt ?? 0) + '%'"
                              ></span>
                            </div>
                          </div>
                        </template>
                      </div>
                    </template>

                    <!-- Thermostat controls -->
                    <template
                      x-if="$store.app.selectedDevice.type === 'thermostat'"
                    >
                      <div class="control-row">
                        <span class="control-label">Setpoint</span>
                        <div class="slider-control">
                          <input
                            type="range"
                            class="slider"
                            min="15"
                            max="30"
                            step="0.5"
                            :value="$store.app.selectedDevice.state?.setpoint ?? 21"
                            @change="$store.app.sendCommand($store.app.selectedDeviceId, 'setpoint', parseFloat($event.target.value))"
                          />
                          <span
                            class="slider-value"
                            x-text="($store.app.selectedDevice.state?.setpoint ?? 21) + '¬∞C'"
                          ></span>
                        </div>
                      </div>
                    </template>

                    <!-- Presence controls -->
                    <template
                      x-if="['presence', 'presence_detector', 'presence_sensor'].includes($store.app.selectedDevice.type)"
                    >
                      <div>
                        <div class="control-row">
                          <span class="control-label">Motion</span>
                          <button
                            class="toggle-btn"
                            :class="{ 'on': $store.app.selectedDevice.state?.presence }"
                            @click="$store.app.sendCommand($store.app.selectedDeviceId, 'presence', !$store.app.selectedDevice.state?.presence)"
                          >
                            <span
                              x-text="$store.app.selectedDevice.state?.presence ? 'DETECTED' : 'CLEAR'"
                            ></span>
                          </button>
                        </div>
                        <div class="control-row">
                          <span class="control-label">Lux Level</span>
                          <div class="slider-control">
                            <input
                              type="range"
                              class="slider"
                              min="0"
                              max="2000"
                              step="10"
                              :value="$store.app.selectedDevice.state?.lux ?? 300"
                              @change="$store.app.sendCommand($store.app.selectedDeviceId, 'lux', parseInt($event.target.value))"
                            />
                            <span
                              class="slider-value"
                              x-text="($store.app.selectedDevice.state?.lux ?? 300) + ' lx'"
                            ></span>
                          </div>
                        </div>
                      </div>
                    </template>

                    <!-- Push button / Wall switch controls -->
                    <template
                      x-if="$store.app.selectedDevice.type === 'template_device' || $store.app.selectedDevice.type === 'push_button'"
                    >
                      <div>
                        <template
                          x-for="(ga, btnName) in $store.app.getButtonGAs($store.app.selectedDevice)"
                          :key="btnName"
                        >
                          <div class="control-row">
                            <span
                              class="control-label"
                              x-text="btnName.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())"
                            ></span>
                            <button
                              class="toggle-btn push-btn-ctrl"
                              :class="{ 'on': $store.app.selectedDevice.state?.[btnName] }"
                              @click="$store.app.toggleButton($store.app.selectedDeviceId, btnName, $store.app.selectedDevice.state?.[btnName])"
                            >
                              <span
                                x-text="$store.app.selectedDevice.state?.[btnName] ? 'ON' : 'OFF'"
                              ></span>
                            </button>
                          </div>
                        </template>
                        <p class="control-hint">
                          Click to toggle - sends command to linked devices via
                          shared GA
                        </p>
                      </div>
                    </template>
                  </div>
                </div>

                <!-- Device Actions -->
                <div class="detail-section">
                  <h4>Actions</h4>
                  <div class="device-actions">
                    <button
                      class="btn btn-small"
                      @click="$store.modal.show('device', 'edit', $store.app.selectedDevice)"
                    >
                      ‚úèÔ∏è Edit Device
                    </button>
                    <button
                      class="btn btn-small btn-danger"
                      @click="$store.modal.confirm('Delete Device', `Delete '${$store.app.formatDeviceName($store.app.selectedDevice.id)}'?`, () => $store.app.deleteDevice($store.app.selectedDeviceId))"
                    >
                      üóëÔ∏è Delete
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </template>
        </aside>
      </main>

      <!-- Telegram Inspector -->
      <section
        class="telegram-inspector"
        x-data="telegramResizer()"
        :style="{ height: height + 'px' }"
      >
        <div class="telegram-resize-handle" @mousedown="startResize"></div>
        <div class="inspector-header">
          <h3>Telegram Inspector</h3>
          <div class="inspector-controls">
            <label for="telegram-filter" class="visually-hidden"
              >Filter telegrams</label
            >
            <select
              id="telegram-filter"
              name="telegram-filter"
              class="filter-select"
              x-model="$store.telegrams.filter"
              @change="$store.telegrams.setFilter($event.target.value)"
            >
              <option value="all">All</option>
              <option value="rx">RX Only</option>
              <option value="tx">TX Only</option>
            </select>
            <button
              class="btn btn-small"
              @click="$store.telegrams.copyToClipboard()"
              title="Copy visible telegrams to clipboard"
            >
              üìã Copy
            </button>
            <button class="btn btn-small" @click="$store.telegrams.clear()">
              Clear
            </button>
            <button
              class="btn btn-small"
              :class="{ 'btn-warning': $store.telegrams.paused }"
              @click="$store.telegrams.togglePause()"
              x-text="$store.telegrams.paused ? 'Resume (' + $store.telegrams.bufferedCount + ')' : 'Pause'"
            ></button>
          </div>
        </div>
        <div class="telegram-feed">
          <!-- Column headers -->
          <div class="telegram-header">
            <span>Time</span>
            <span>Dir</span>
            <span>Source</span>
            <span>APCI</span>
            <span>Group Address</span>
            <span>Device</span>
            <span>Payload</span>
            <span>Value</span>
            <span>DPT</span>
          </div>
          <div class="telegram-body">
            <div
              class="telegram-placeholder"
              x-show="$store.telegrams.filtered.length === 0"
            >
              <p>Waiting for telegrams...</p>
            </div>
            <template
              x-for="telegram in $store.telegrams.filtered"
              :key="telegram.id"
            >
              <div
                class="telegram-row"
                :class="{ 'apci-read': telegram.apci === 'GroupValue_Read' }"
              >
                <span
                  class="telegram-time"
                  x-text="telegram.time_formatted || '-'"
                ></span>
                <span
                  class="telegram-dir"
                  :class="telegram.direction"
                  x-text="telegram.direction === 'rx' ? '‚Üê RX' : '‚Üí TX'"
                ></span>
                <span
                  class="telegram-source"
                  x-text="telegram.source || '-'"
                ></span>
                <span
                  class="telegram-apci"
                  x-text="telegram.apci || '-'"
                ></span>
                <span
                  class="telegram-ga"
                  x-text="telegram.destination + (telegram.ga_function ? ' (' + telegram.ga_function + ')' : '')"
                ></span>
                <span
                  class="telegram-device"
                  x-text="telegram.device_id || '-'"
                ></span>
                <span
                  class="telegram-payload"
                  x-text="telegram.payload || '-'"
                ></span>
                <span
                  class="telegram-decoded"
                  x-text="telegram.decoded_value !== undefined && telegram.decoded_value !== null ? telegram.decoded_value + (telegram.unit ? ' ' + telegram.unit : '') : '-'"
                ></span>
                <span class="telegram-dpt" x-text="telegram.dpt || '-'"></span>
              </div>
            </template>
            <!-- Load More / Scroll Sentinel -->
            <div
              class="telegram-load-more"
              x-show="$store.telegrams.hasMore"
              x-intersect:enter.margin.100px="$store.telegrams.loadMore($store.app.currentPremiseId)"
            >
              <button
                class="btn btn-small"
                :disabled="$store.telegrams.loading"
                @click="$store.telegrams.loadMore($store.app.currentPremiseId)"
                x-text="$store.telegrams.loading ? 'Loading...' : 'Load More (' + ($store.telegrams.totalBuffered - $store.telegrams.items.length) + ' older)'"
              ></button>
            </div>
            <div
              class="telegram-end"
              x-show="!$store.telegrams.hasMore && $store.telegrams.items.length > 0"
            >
              <span class="end-text">‚Äî End of history ‚Äî</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Stats Bar -->
      <footer class="stats-bar">
        <div class="stat">
          <span class="stat-label">Devices:</span>
          <span class="stat-value" x-text="$store.app.devices.length"></span>
        </div>
        <div class="stat">
          <span class="stat-label">Telegrams/s:</span>
          <span class="stat-value" x-text="$store.app.tps"></span>
        </div>
        <div class="stat">
          <span class="stat-label">Rooms:</span>
          <span
            class="stat-value"
            x-text="$store.app.roomsWithDevices.filter(r => r.id !== '_unassigned').length"
          ></span>
        </div>
      </footer>

      <!-- Floating Action Button (Engineer Mode) -->
      <button
        class="fab"
        x-show="$store.app.engineerMode"
        @click="$store.modal.show('template-browser', 'create')"
        title="Add Device"
      >
        +
      </button>

      <!-- Modal Overlay -->
      <div
        class="modal-overlay"
        x-show="$store.modal.open"
        x-transition:enter="modal-enter"
        x-transition:leave="modal-leave"
        @click.self="$store.modal.close()"
      >
        <!-- Floor Modal -->
        <div
          class="modal"
          x-show="$store.modal.type === 'floor'"
          @click.stop
          x-data="floorForm()"
        >
          <div class="modal-header">
            <h3
              x-text="$store.modal.mode === 'create' ? 'Add Floor' : 'Edit Floor'"
            ></h3>
            <button class="btn-close" @click="$store.modal.close()">
              &times;
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="floor-id">Floor ID</label>
              <input
                type="text"
                id="floor-id"
                x-model="form.id"
                :disabled="$store.modal.mode === 'edit'"
                placeholder="e.g., ground, first, basement"
              />
            </div>
            <div class="form-group">
              <label for="floor-name">Floor Name</label>
              <input
                type="text"
                id="floor-name"
                x-model="form.name"
                placeholder="e.g., Ground Floor"
              />
            </div>
            <div class="form-group">
              <label for="floor-sort">Sort Order</label>
              <input
                type="number"
                id="floor-sort"
                x-model.number="form.sort_order"
                placeholder="0"
              />
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn" @click="$store.modal.close()">Cancel</button>
            <button
              class="btn btn-primary"
              @click="submit()"
              :disabled="!form.id || !form.name"
            >
              <span
                x-text="$store.modal.mode === 'create' ? 'Create' : 'Save'"
              ></span>
            </button>
          </div>
        </div>

        <!-- Area Modal -->
        <div
          class="modal"
          x-show="$store.modal.type === 'area'"
          @click.stop
          x-data="{
            form: {
              area_number: 0,
              name: '',
              description: ''
            },
            init() {
              if ($store.modal.mode === 'edit' && $store.modal.data) {
                this.form = { 
                  area_number: $store.modal.data.area_number,
                  name: $store.modal.data.name || '',
                  description: $store.modal.data.description || ''
                };
              } else {
                // Suggest next available area number
                const areas = $store.app.topology?.areas || [];
                const usedNumbers = areas.map(a => a.area_number);
                for (let i = 1; i <= 15; i++) {
                  if (!usedNumbers.includes(i)) {
                    this.form.area_number = i;
                    break;
                  }
                }
                this.form.name = 'Area ' + this.form.area_number;
              }
            },
            async submit() {
              if ($store.modal.mode === 'create') {
                await $store.app.createArea(this.form);
              } else {
                await $store.app.updateArea($store.modal.data.id, this.form);
              }
            }
          }"
        >
          <div class="modal-header">
            <h3 x-text="$store.modal.mode === 'create' ? 'Add Area' : 'Edit Area'"></h3>
            <button class="btn-close" @click="$store.modal.close()">&times;</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="area-number">Area Number</label>
              <input
                type="number"
                id="area-number"
                x-model.number="form.area_number"
                min="0"
                max="15"
                :disabled="$store.modal.mode === 'edit'"
              />
              <small class="form-hint">0-15 (KNX topology limit)</small>
            </div>
            <div class="form-group">
              <label for="area-name">Name</label>
              <input
                type="text"
                id="area-name"
                x-model="form.name"
                placeholder="e.g., Main Building, Ground Floor Zone"
              />
            </div>
            <div class="form-group">
              <label for="area-desc">Description (optional)</label>
              <textarea
                id="area-desc"
                x-model="form.description"
                rows="2"
                placeholder="Optional description"
              ></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn" @click="$store.modal.close()">Cancel</button>
            <button
              class="btn btn-primary"
              @click="submit()"
              :disabled="!form.name"
            >
              <span x-text="$store.modal.mode === 'create' ? 'Create' : 'Save'"></span>
            </button>
          </div>
        </div>

        <!-- Line Modal -->
        <div
          class="modal"
          x-show="$store.modal.type === 'line'"
          @click.stop
          x-data="{
            form: {
              line_number: 0,
              name: '',
              description: ''
            },
            init() {
              if ($store.modal.mode === 'edit' && $store.modal.data) {
                this.form = { 
                  line_number: $store.modal.data.line_number,
                  name: $store.modal.data.name || '',
                  description: $store.modal.data.description || ''
                };
              } else {
                // Suggest next available line number for this area
                const areaId = $store.modal.data.area_id;
                const areaNum = $store.modal.data.area_number || 1;
                const area = $store.app.topology?.areas?.find(a => a.id === areaId);
                const usedNumbers = (area?.lines || []).map(l => l.line_number);
                for (let i = 1; i <= 15; i++) {
                  if (!usedNumbers.includes(i)) {
                    this.form.line_number = i;
                    break;
                  }
                }
                this.form.name = 'Line ' + areaNum + '.' + this.form.line_number;
              }
            },
            async submit() {
              const areaId = $store.modal.data.area_id;
              if ($store.modal.mode === 'create') {
                await $store.app.createLine(areaId, this.form);
              } else {
                await $store.app.updateLine(areaId, $store.modal.data.id, this.form);
              }
            }
          }"
        >
          <div class="modal-header">
            <h3 x-text="$store.modal.mode === 'create' ? 'Add Line' : 'Edit Line'"></h3>
            <button class="btn-close" @click="$store.modal.close()">&times;</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label>Area</label>
              <input
                type="text"
                :value="'Area ' + ($store.modal.data.area_number || 1)"
                disabled
              />
            </div>
            <div class="form-group">
              <label for="line-number">Line Number</label>
              <input
                type="number"
                id="line-number"
                x-model.number="form.line_number"
                min="0"
                max="15"
                :disabled="$store.modal.mode === 'edit'"
              />
              <small class="form-hint">0-15 (KNX topology limit)</small>
            </div>
            <div class="form-group">
              <label for="line-name">Name</label>
              <input
                type="text"
                id="line-name"
                x-model="form.name"
                placeholder="e.g., Lighting, Sensors, HVAC"
              />
            </div>
            <div class="form-group">
              <label for="line-desc">Description (optional)</label>
              <textarea
                id="line-desc"
                x-model="form.description"
                rows="2"
                placeholder="Optional description"
              ></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn" @click="$store.modal.close()">Cancel</button>
            <button
              class="btn btn-primary"
              @click="submit()"
              :disabled="!form.name"
            >
              <span x-text="$store.modal.mode === 'create' ? 'Create' : 'Save'"></span>
            </button>
          </div>
        </div>

        <!-- Room Modal -->
        <div
          class="modal"
          x-show="$store.modal.type === 'room'"
          @click.stop
          x-data="roomForm()"
        >
          <div class="modal-header">
            <h3
              x-text="$store.modal.mode === 'create' ? 'Add Room' : 'Edit Room'"
            ></h3>
            <button class="btn-close" @click="$store.modal.close()">
              &times;
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="room-id">Room ID</label>
              <input
                type="text"
                id="room-id"
                x-model="form.id"
                :disabled="$store.modal.mode === 'edit'"
                placeholder="e.g., living-room, bedroom-1"
              />
            </div>
            <div class="form-group">
              <label for="room-name">Room Name</label>
              <input
                type="text"
                id="room-name"
                x-model="form.name"
                placeholder="e.g., Living Room"
              />
            </div>
            <div class="form-group">
              <label for="room-type">Room Type</label>
              <select id="room-type" x-model="form.room_type">
                <template
                  x-for="type in $store.app.ROOM_TYPES"
                  :key="type.value"
                >
                  <option :value="type.value" x-text="type.label"></option>
                </template>
              </select>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="room-col">Grid Column</label>
                <input
                  type="number"
                  id="room-col"
                  x-model.number="form.grid_col"
                  min="0"
                  max="11"
                />
              </div>
              <div class="form-group">
                <label for="room-row">Grid Row</label>
                <input
                  type="number"
                  id="room-row"
                  x-model.number="form.grid_row"
                  min="0"
                  max="11"
                />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="room-width">Width</label>
                <input
                  type="number"
                  id="room-width"
                  x-model.number="form.grid_width"
                  min="1"
                  max="12"
                />
              </div>
              <div class="form-group">
                <label for="room-height">Height</label>
                <input
                  type="number"
                  id="room-height"
                  x-model.number="form.grid_height"
                  min="1"
                  max="12"
                />
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn" @click="$store.modal.close()">Cancel</button>
            <button
              class="btn btn-primary"
              @click="submit()"
              :disabled="!form.id || !form.name"
            >
              <span
                x-text="$store.modal.mode === 'create' ? 'Create' : 'Save'"
              ></span>
            </button>
          </div>
        </div>

        <!-- Main Group Modal -->
        <div
          class="modal"
          x-show="$store.modal.type === 'mainGroup'"
          @click.stop
          x-data="{
            form: { group_number: 0, name: '', description: '' },
            init() {
              this.$watch('$store.modal.open', (open) => {
                if (open && this.$store.modal.type === 'mainGroup') {
                  if (this.$store.modal.mode === 'edit' && this.$store.modal.data) {
                    this.form = { ...this.$store.modal.data };
                  } else {
                    // Find next available main group number
                    const used = $store.groups.mainGroups.map(g => g.group_number);
                    let next = 0;
                    while (used.includes(next) && next < 32) next++;
                    this.form = { group_number: next, name: '', description: '' };
                  }
                }
              });
            },
            async submit() {
              const premiseId = $store.app.currentPremiseId;
              if (this.$store.modal.mode === 'create') {
                await $store.groups.createMainGroup(premiseId, this.form);
              } else {
                await $store.groups.updateMainGroup(this.$store.modal.data.id, this.form);
              }
              $store.modal.close();
            }
          }"
        >
          <div class="modal-header">
            <h3 x-text="$store.modal.mode === 'create' ? 'Add Main Group' : 'Edit Main Group'"></h3>
            <button class="btn-close" @click="$store.modal.close()">&times;</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="main-group-number">Group Number (0-31)</label>
              <input
                type="number"
                id="main-group-number"
                x-model.number="form.group_number"
                min="0"
                max="31"
                :disabled="$store.modal.mode === 'edit'"
              />
              <small class="help-text">Main groups are typically function-based: 0=Lighting, 1=Blinds, 2=HVAC, etc.</small>
            </div>
            <div class="form-group">
              <label for="main-group-name">Name</label>
              <input
                type="text"
                id="main-group-name"
                x-model="form.name"
                placeholder="e.g. Lighting, Blinds, HVAC"
              />
            </div>
            <div class="form-group">
              <label for="main-group-desc">Description (optional)</label>
              <input
                type="text"
                id="main-group-desc"
                x-model="form.description"
                placeholder="e.g. Switch and dimming controls"
              />
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn" @click="$store.modal.close()">Cancel</button>
            <button
              class="btn btn-primary"
              @click="submit()"
              :disabled="!form.name"
            >
              <span x-text="$store.modal.mode === 'create' ? 'Create' : 'Save'"></span>
            </button>
          </div>
        </div>

        <!-- Middle Group Modal -->
        <div
          class="modal"
          x-show="$store.modal.type === 'middleGroup'"
          @click.stop
          x-data="{
            form: { group_number: 0, name: '', description: '', floor_id: '' },
            mainGroupId: null,
            mainGroupNumber: null,
            init() {
              this.$watch('$store.modal.open', (open) => {
                if (open && this.$store.modal.type === 'middleGroup') {
                  const data = this.$store.modal.data || {};
                  this.mainGroupId = data.main_group_id || data.main_group_id;
                  this.mainGroupNumber = data.main_group_number;
                  if (this.$store.modal.mode === 'edit') {
                    this.form = {
                      group_number: data.group_number,
                      name: data.name,
                      description: data.description || '',
                      floor_id: data.floor_id || ''
                    };
                  } else {
                    // Find next available middle group number
                    const mainGroup = $store.groups.mainGroups.find(g => g.id === this.mainGroupId);
                    const used = (mainGroup?.middle_groups || []).map(g => g.group_number);
                    let next = 0;
                    while (used.includes(next) && next < 8) next++;
                    this.form = { group_number: next, name: '', description: '', floor_id: '' };
                  }
                }
              });
            },
            async submit() {
              if (this.$store.modal.mode === 'create') {
                await $store.groups.createMiddleGroup(this.mainGroupId, this.form);
              } else {
                await $store.groups.updateMiddleGroup(this.$store.modal.data.id, this.form);
              }
              $store.modal.close();
            }
          }"
        >
          <div class="modal-header">
            <h3 x-text="$store.modal.mode === 'create' ? 'Add Middle Group' : 'Edit Middle Group'"></h3>
            <button class="btn-close" @click="$store.modal.close()">&times;</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="middle-group-number">Group Number (0-7)</label>
              <input
                type="number"
                id="middle-group-number"
                x-model.number="form.group_number"
                min="0"
                max="7"
                :disabled="$store.modal.mode === 'edit'"
              />
              <small class="help-text">Middle groups are typically location-based: 0=Ground Floor, 1=First Floor, etc.</small>
            </div>
            <div class="form-group">
              <label for="middle-group-name">Name</label>
              <input
                type="text"
                id="middle-group-name"
                x-model="form.name"
                placeholder="e.g. Ground Floor, First Floor"
              />
            </div>
            <div class="form-group">
              <label for="middle-group-floor">Link to Floor (optional)</label>
              <select id="middle-group-floor" x-model="form.floor_id">
                <option value="">-- No floor link --</option>
                <template x-for="floor in $store.app.floors" :key="floor.id">
                  <option :value="floor.id" x-text="floor.name"></option>
                </template>
              </select>
              <small class="help-text">Linking to a floor enables automatic GA suggestions for devices in that floor's rooms.</small>
            </div>
            <div class="form-group">
              <label for="middle-group-desc">Description (optional)</label>
              <input
                type="text"
                id="middle-group-desc"
                x-model="form.description"
              />
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn" @click="$store.modal.close()">Cancel</button>
            <button
              class="btn btn-primary"
              @click="submit()"
              :disabled="!form.name"
            >
              <span x-text="$store.modal.mode === 'create' ? 'Create' : 'Save'"></span>
            </button>
          </div>
        </div>

        <!-- Device Modal -->
        <div
          class="modal modal-wide"
          x-show="$store.modal.type === 'device'"
          @click.stop
          x-data="deviceForm()"
        >
          <div class="modal-header">
            <h3
              x-text="$store.modal.mode === 'create' ? 'Add Device' : 'Edit Device'"
            ></h3>
            <button class="btn-close" @click="$store.modal.close()">
              &times;
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="device-id">Device ID</label>
              <input
                type="text"
                id="device-id"
                x-model="form.id"
                :disabled="$store.modal.mode === 'edit'"
                placeholder="e.g., living-room-light-1"
              />
            </div>
            <div class="form-group">
              <label for="device-type">Device Type</label>
              <select
                id="device-type"
                x-model="form.type"
                :disabled="$store.modal.mode === 'edit'"
                @change="onTypeChange()"
              >
                <option value="light_switch">Light Switch</option>
                <option value="light_dimmer">Light Dimmer</option>
                <option value="blind">Blind</option>
                <option value="blind_position_slat">Blind with Slat</option>
                <option value="sensor">Temperature Sensor</option>
                <option value="presence">Presence Detector</option>
                <option value="thermostat">Thermostat</option>
              </select>
            </div>
            <div class="form-group">
              <label for="device-addr">Individual Address</label>
              <div class="input-with-button">
                <input
                  type="text"
                  id="device-addr"
                  x-model="form.individual_address"
                  placeholder="e.g., 1.1.1"
                  pattern="\d+\.\d+\.\d+"
                />
                <button 
                  type="button" 
                  class="btn btn-small"
                  @click="suggestIA()"
                  title="Suggest next available address"
                >Suggest</button>
              </div>
              <small class="form-hint">Format: area.line.device (e.g., 1.1.1) ‚Äî <span x-text="getIAHint()"></span></small>
            </div>
            <div class="form-group">
              <label for="device-room">Room</label>
              <select id="device-room" x-model="form.room_id">
                <option value="">Unassigned</option>
                <template x-for="floor in $store.app.floors" :key="floor.id">
                  <optgroup :label="floor.name">
                    <template x-for="room in floor.rooms || []" :key="room.id">
                      <option :value="room.id" x-text="room.name"></option>
                    </template>
                  </optgroup>
                </template>
              </select>
            </div>
            
            <!-- Group Addresses Section -->
            <div class="form-group">
              <div class="ga-section-header">
                <label>Group Addresses</label>
                <button 
                  type="button" 
                  class="btn btn-small btn-outline"
                  @click="showHelp = !showHelp"
                >
                  <span x-text="showHelp ? '‚úï Hide Help' : '? Help & Reference'"></span>
                </button>
              </div>
              
              <!-- Help Panel (collapsible) -->
              <div class="ga-help-panel" x-show="showHelp" x-collapse>
                <div class="ga-help-tabs">
                  <button 
                    type="button"
                    class="ga-help-tab" 
                    :class="{ active: helpTab === 'recommended' }"
                    @click="helpTab = 'recommended'"
                  >Recommended</button>
                  <button 
                    type="button"
                    class="ga-help-tab" 
                    :class="{ active: helpTab === 'all-devices' }"
                    @click="helpTab = 'all-devices'"
                  >All Devices</button>
                  <button 
                    type="button"
                    class="ga-help-tab" 
                    :class="{ active: helpTab === 'all-gas' }"
                    @click="helpTab = 'all-gas'"
                  >All GAs</button>
                  <button 
                    type="button"
                    class="ga-help-tab" 
                    :class="{ active: helpTab === 'individual' }"
                    @click="helpTab = 'individual'"
                  >IA Help</button>
                  <button 
                    type="button"
                    class="ga-help-tab" 
                    :class="{ active: helpTab === 'addressing' }"
                    @click="helpTab = 'addressing'"
                  >GA Help</button>
                  <button 
                    type="button"
                    class="ga-help-tab" 
                    :class="{ active: helpTab === 'dpts' }"
                    @click="helpTab = 'dpts'"
                  >DPTs</button>
                  <button 
                    type="button"
                    class="ga-help-tab" 
                    :class="{ active: helpTab === 'flags' }"
                    @click="helpTab = 'flags'"
                  >Flags</button>
                </div>
                
                <!-- All Devices Reference -->
                <div class="ga-help-content" x-show="helpTab === 'all-devices'">
                  <p class="help-intro">All devices in this premise, grouped by line:</p>
                  <template x-if="Object.keys($store.reference.getDevicesByLine()).length > 0">
                    <div class="all-devices-list">
                      <template x-for="(lineData, lineKey) in $store.reference.getDevicesByLine()" :key="lineKey">
                        <div class="device-line-group">
                          <div class="line-header">
                            <span class="line-label">Line <code x-text="lineKey + '.x'"></code></span>
                            <span class="line-count" x-text="lineData.devices.length + ' device(s)'"></span>
                          </div>
                          <div class="line-devices">
                            <template x-for="dev in lineData.devices" :key="dev.id">
                              <div 
                                class="device-ref-item"
                                :class="{ 'current': dev.id === form.id }"
                                @click="form.individual_address || (form.individual_address = $store.reference.suggestNextIA(lineKey))"
                              >
                                <code class="dev-addr" x-text="dev.address"></code>
                                <span class="dev-id" x-text="dev.id"></span>
                                <span class="dev-type" x-text="dev.type"></span>
                              </div>
                            </template>
                          </div>
                          <button 
                            type="button" 
                            class="btn btn-small btn-outline"
                            @click="form.individual_address = $store.reference.suggestNextIA(lineKey)"
                          >Use next on this line ‚Üí <code x-text="$store.reference.suggestNextIA(lineKey)"></code></button>
                        </div>
                      </template>
                    </div>
                  </template>
                  <template x-if="Object.keys($store.reference.getDevicesByLine()).length === 0">
                    <div class="help-empty">
                      <p>No devices yet. First device will be assigned to a new line.</p>
                      <button 
                        type="button" 
                        class="btn btn-small"
                        @click="form.individual_address = '1.1.1'"
                      >Start with 1.1.1</button>
                    </div>
                  </template>
                </div>
                
                <!-- All GAs Reference -->
                <div class="ga-help-content" x-show="helpTab === 'all-gas'">
                  <p class="help-intro">All group addresses in use (<span x-text="$store.reference.getAllUsedGAs().length"></span> total):</p>
                  <div class="ga-search-input">
                    <input 
                      type="text" 
                      placeholder="Filter GAs..."
                      x-model="gaFilter"
                    />
                  </div>
                  <div class="all-gas-list">
                    <template x-for="gaEntry in $store.reference.getAllUsedGAs().filter(g => !gaFilter || g.ga.includes(gaFilter) || g.devices.some(d => d.toLowerCase().includes(gaFilter.toLowerCase())))" :key="gaEntry.ga">
                      <div class="ga-ref-item">
                        <div class="ga-ref-header">
                          <code class="ga-addr" x-text="gaEntry.ga"></code>
                          <span class="ga-device-count" x-text="gaEntry.devices.length + ' device(s)'"></span>
                        </div>
                        <div class="ga-ref-usages">
                          <template x-for="usage in gaEntry.usages" :key="usage.device + usage.name">
                            <span class="ga-usage-chip">
                              <span class="usage-device" x-text="usage.device"></span>.<span class="usage-name" x-text="usage.name"></span>
                              <code class="usage-dpt" x-show="usage.dpt" x-text="usage.dpt"></code>
                            </span>
                          </template>
                        </div>
                      </div>
                    </template>
                  </div>
                  <template x-if="$store.reference.getAllUsedGAs().length === 0">
                    <p class="help-empty">No group addresses configured yet.</p>
                  </template>
                </div>
                
                <!-- Recommended GAs for this device type -->
                <div class="ga-help-content" x-show="helpTab === 'recommended'">
                  <template x-if="$store.reference.getRecommendedGAs(form.type)">
                    <div>
                      <p class="help-intro" x-text="$store.reference.getRecommendedGAs(form.type)?.description"></p>
                      <table class="help-table">
                        <thead>
                          <tr><th>Name</th><th>DPT</th><th>Flags</th><th>Purpose</th></tr>
                        </thead>
                        <tbody>
                          <template x-for="ga in $store.reference.getRecommendedGAs(form.type)?.recommended_gas || []" :key="ga.name">
                            <tr>
                              <td><code x-text="ga.name"></code></td>
                              <td><code x-text="ga.dpt"></code></td>
                              <td><code x-text="ga.flags"></code></td>
                              <td x-text="ga.description"></td>
                            </tr>
                          </template>
                        </tbody>
                      </table>
                      <button 
                        type="button" 
                        class="btn btn-small btn-primary"
                        @click="applyRecommendedGAs()"
                        style="margin-top: 0.5rem;"
                      >Apply Recommended Structure</button>
                    </div>
                  </template>
                  <template x-if="!$store.reference.getRecommendedGAs(form.type)">
                    <p class="help-empty">No recommended structure for this device type.</p>
                  </template>
                </div>
                
                <!-- Individual Address Reference -->
                <div class="ga-help-content" x-show="helpTab === 'individual'">
                  <template x-if="$store.reference.individualAddress">
                    <div>
                      <p class="help-intro" x-text="$store.reference.individualAddress.description"></p>
                      
                      <div class="ga-format-box">
                        <strong>Format:</strong> <code x-text="$store.reference.individualAddress.format"></code>
                        <span class="ga-bits" x-text="'(' + $store.reference.individualAddress.bits + ')'"></span>
                      </div>
                      
                      <h5>Address Components</h5>
                      <table class="help-table">
                        <thead>
                          <tr><th>Part</th><th>Range</th><th>Description</th></tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td><code>Area</code></td>
                            <td x-text="$store.reference.individualAddress.structure.area.range"></td>
                            <td x-text="$store.reference.individualAddress.structure.area.description"></td>
                          </tr>
                          <tr>
                            <td><code>Line</code></td>
                            <td x-text="$store.reference.individualAddress.structure.line.range"></td>
                            <td x-text="$store.reference.individualAddress.structure.line.description"></td>
                          </tr>
                          <tr>
                            <td><code>Device</code></td>
                            <td x-text="$store.reference.individualAddress.structure.device.range"></td>
                            <td x-text="$store.reference.individualAddress.structure.device.description"></td>
                          </tr>
                        </tbody>
                      </table>
                      
                      <h5 style="margin-top: 1rem;">Special Addresses</h5>
                      <div class="ga-examples">
                        <template x-for="special in $store.reference.individualAddress.special_addresses" :key="special.address">
                          <div class="ga-example">
                            <code x-text="special.address"></code>
                            <span><strong x-text="special.meaning"></strong> ‚Äî <span x-text="special.note"></span></span>
                          </div>
                        </template>
                      </div>
                      
                      <h5 style="margin-top: 1rem;">Individual vs Group Address</h5>
                      <div class="addr-comparison">
                        <div class="addr-compare-item">
                          <strong>Individual (1.1.1)</strong>
                          <p x-text="$store.reference.individualAddress.vs_group_address.individual"></p>
                        </div>
                        <div class="addr-compare-item">
                          <strong>Group (1/1/1)</strong>
                          <p x-text="$store.reference.individualAddress.vs_group_address.group"></p>
                        </div>
                        <div class="addr-compare-analogy">
                          <em x-text="'üí° ' + $store.reference.individualAddress.vs_group_address.analogy"></em>
                        </div>
                      </div>
                      
                      <div class="ga-tips">
                        <h5>Tips</h5>
                        <ul>
                          <template x-for="tip in $store.reference.individualAddress.tips" :key="tip">
                            <li x-text="tip"></li>
                          </template>
                        </ul>
                      </div>
                    </div>
                  </template>
                </div>
                
                <!-- DPT Reference -->
                <div class="ga-help-content" x-show="helpTab === 'dpts'">
                  <div class="dpt-search">
                    <input 
                      type="text" 
                      placeholder="Search DPTs (e.g., temperature, 9.001, switch...)"
                      x-model="dptSearch"
                    />
                  </div>
                  <div class="dpt-results">
                    <template x-for="dpt in $store.reference.searchDpts(dptSearch).slice(0, 15)" :key="dpt.id">
                      <div class="dpt-item" @click="copyDpt(dpt.id)">
                        <div class="dpt-id"><code x-text="dpt.id"></code></div>
                        <div class="dpt-info">
                          <span class="dpt-name" x-text="dpt.name"></span>
                          <span class="dpt-unit" x-show="dpt.unit" x-text="'(' + dpt.unit + ')'"></span>
                          <span class="dpt-range" x-show="dpt.range" x-text="dpt.range"></span>
                        </div>
                        <div class="dpt-use" x-text="dpt.use_case"></div>
                      </div>
                    </template>
                  </div>
                  <p class="help-hint">Click a DPT to copy it</p>
                </div>
                
                <!-- GA Addressing Structure -->
                <div class="ga-help-content" x-show="helpTab === 'addressing'">
                  <template x-if="$store.reference.gaStructure">
                    <div>
                      <p class="help-intro" x-text="$store.reference.gaStructure.description"></p>
                      <div class="ga-format-box">
                        <strong>Format:</strong> <code x-text="$store.reference.gaStructure.format"></code>
                        <span class="ga-bits" x-text="'(' + $store.reference.gaStructure.bits + ')'"></span>
                      </div>
                      <template x-for="conv in $store.reference.gaStructure.conventions.slice(0, 2)" :key="conv.name">
                        <div class="ga-convention">
                          <h5 x-text="conv.name"></h5>
                          <p x-text="conv.description"></p>
                          <div class="ga-examples">
                            <template x-for="ex in conv.example_addresses || []" :key="ex.ga">
                              <div class="ga-example">
                                <code x-text="ex.ga"></code>
                                <span x-text="ex.meaning"></span>
                              </div>
                            </template>
                          </div>
                        </div>
                      </template>
                      <div class="ga-tips">
                        <h5>Tips</h5>
                        <ul>
                          <template x-for="tip in $store.reference.gaStructure.tips" :key="tip">
                            <li x-text="tip"></li>
                          </template>
                        </ul>
                      </div>
                    </div>
                  </template>
                </div>
                
                <!-- Flags Reference -->
                <div class="ga-help-content" x-show="helpTab === 'flags'">
                  <template x-if="$store.reference.flags">
                    <div>
                      <p class="help-intro" x-text="$store.reference.flags.description"></p>
                      <table class="help-table">
                        <thead>
                          <tr><th>Flag</th><th>Name</th><th>Description</th></tr>
                        </thead>
                        <tbody>
                          <template x-for="flag in $store.reference.flags.flags" :key="flag.letter">
                            <tr>
                              <td><code x-text="flag.letter"></code></td>
                              <td x-text="flag.name"></td>
                              <td x-text="flag.description"></td>
                            </tr>
                          </template>
                        </tbody>
                      </table>
                      <h5 style="margin-top: 1rem;">Common Patterns</h5>
                      <div class="flag-patterns">
                        <template x-for="pattern in $store.reference.flags.common_patterns" :key="pattern.flags">
                          <div class="flag-pattern">
                            <code x-text="pattern.flags"></code>
                            <span class="pattern-use" x-text="pattern.use_case"></span>
                          </div>
                        </template>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
              
              <!-- GA Editor -->
              <div class="ga-editor">
                <div class="ga-editor-header">
                  <span class="ga-editor-col-name">Name</span>
                  <span class="ga-editor-col-ga">GA</span>
                  <span class="ga-editor-col-dpt">DPT</span>
                  <span class="ga-editor-col-flags">Flags</span>
                  <span class="ga-editor-col-actions"></span>
                </div>
                <template
                  x-for="(gaData, name) in form.group_addresses"
                  :key="name"
                >
                  <div class="ga-row">
                    <input type="text" :value="name" disabled class="ga-name" />
                    <input
                      type="text"
                      :value="typeof gaData === 'object' ? gaData.ga : gaData"
                      @input="updateGA(name, 'ga', $event.target.value)"
                      placeholder="1/0/1"
                      class="ga-value"
                    />
                    <input
                      type="text"
                      :value="typeof gaData === 'object' ? gaData.dpt : ''"
                      @input="updateGA(name, 'dpt', $event.target.value)"
                      placeholder="1.001"
                      class="ga-dpt"
                      :title="getDptTooltip(typeof gaData === 'object' ? gaData.dpt : '')"
                    />
                    <input
                      type="text"
                      :value="typeof gaData === 'object' ? gaData.flags : ''"
                      @input="updateGA(name, 'flags', $event.target.value)"
                      placeholder="C-W-U-"
                      class="ga-flags"
                      maxlength="6"
                      :title="$store.app.getFlagsTooltip(typeof gaData === 'object' ? gaData.flags : '')"
                    />
                    <button 
                      type="button" 
                      class="btn-icon btn-danger ga-delete"
                      @click="removeGA(name)"
                      title="Remove GA"
                    >‚úï</button>
                  </div>
                </template>
                <button class="btn btn-small" @click="addGA()" type="button">
                  + Add GA
                </button>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn" @click="$store.modal.close()">Cancel</button>
            <button
              class="btn btn-primary"
              @click="submit()"
              :disabled="!form.id || !form.individual_address"
            >
              <span
                x-text="$store.modal.mode === 'create' ? 'Create' : 'Save'"
              ></span>
            </button>
          </div>
        </div>

        <!-- Template Browser Modal -->
        <div
          class="modal modal-large"
          x-show="$store.modal.type === 'template-browser'"
          @click.stop
          x-data="templateBrowser()"
        >
          <div class="modal-header">
            <h3>Select Device Template</h3>
            <button class="btn-close" @click="$store.modal.close()">
              &times;
            </button>
          </div>
          <div class="modal-body template-browser">
            <!-- Domain tabs -->
            <div class="domain-tabs">
              <button
                class="domain-tab"
                :class="{ 'active': selectedDomain === null }"
                @click="selectedDomain = null"
              >
                All
              </button>
              <template
                x-for="domain in $store.app.templateDomains"
                :key="domain"
              >
                <button
                  class="domain-tab"
                  :class="{ 'active': selectedDomain === domain }"
                  @click="selectedDomain = domain"
                  x-text="domain.charAt(0).toUpperCase() + domain.slice(1)"
                ></button>
              </template>
            </div>
            <!-- Template grid -->
            <div class="template-grid">
              <template
                x-for="template in filteredTemplates"
                :key="template.id"
              >
                <div class="template-card" @click="selectTemplate(template)">
                  <div
                    class="template-icon"
                    x-text="$store.app.getDeviceIcon(template.type)"
                  ></div>
                  <div class="template-info">
                    <div class="template-name" x-text="template.name"></div>
                    <div
                      class="template-desc"
                      x-text="template.description || template.type"
                    ></div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>

        <!-- Confirm Modal -->
        <div
          class="modal modal-small"
          x-show="$store.modal.type === 'confirm'"
          @click.stop
        >
          <div class="modal-header">
            <h3 x-text="$store.modal.data.title || 'Confirm'"></h3>
            <button class="btn-close" @click="$store.modal.close()">
              &times;
            </button>
          </div>
          <div class="modal-body">
            <p x-text="$store.modal.data.message"></p>
          </div>
          <div class="modal-footer">
            <button class="btn" @click="$store.modal.close()">Cancel</button>
            <button class="btn btn-danger" @click="$store.modal.doConfirm()">
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Alpine component definitions -->
    <script>
      // Floor form component
      function floorForm() {
        return {
          form: {
            id: "",
            name: "",
            sort_order: 0,
          },
          init() {
            this.$watch("$store.modal.open", (open) => {
              if (open && this.$store.modal.type === "floor") {
                if (
                  this.$store.modal.mode === "edit" &&
                  this.$store.modal.data
                ) {
                  this.form = { ...this.$store.modal.data };
                } else {
                  this.form = {
                    id: "",
                    name: "",
                    sort_order: this.$store.app.floors.length,
                  };
                }
              }
            });
          },
          async submit() {
            try {
              if (this.$store.modal.mode === "create") {
                await this.$store.app.createFloor(this.form);
              } else {
                await this.$store.app.updateFloor(this.form.id, {
                  name: this.form.name,
                  sort_order: this.form.sort_order,
                });
              }
              this.$store.modal.close();
            } catch (err) {
              alert("Failed: " + err.message);
            }
          },
        };
      }

      // Room form component
      function roomForm() {
        return {
          form: {
            id: "",
            name: "",
            room_type: "other",
            grid_col: 0,
            grid_row: 0,
            grid_width: 1,
            grid_height: 1,
            floor_id: null,
          },
          init() {
            this.$watch("$store.modal.open", (open) => {
              if (open && this.$store.modal.type === "room") {
                if (
                  this.$store.modal.mode === "edit" &&
                  this.$store.modal.data
                ) {
                  this.form = { ...this.$store.modal.data };
                } else {
                  this.form = {
                    id: "",
                    name: "",
                    room_type: "other",
                    grid_col: 0,
                    grid_row: 0,
                    grid_width: 1,
                    grid_height: 1,
                    floor_id:
                      this.$store.modal.data?.floor_id ||
                      this.$store.app.currentFloorId,
                  };
                }
              }
            });
          },
          async submit() {
            console.log("Room form submit:", this.form);
            try {
              if (this.$store.modal.mode === "create") {
                console.log("Creating room on floor:", this.form.floor_id);
                await this.$store.app.createRoom(this.form.floor_id, this.form);
              } else {
                await this.$store.app.updateRoom(
                  this.form.floor_id,
                  this.form.id,
                  {
                    name: this.form.name,
                    room_type: this.form.room_type,
                    grid_col: this.form.grid_col,
                    grid_row: this.form.grid_row,
                    grid_width: this.form.grid_width,
                    grid_height: this.form.grid_height,
                  },
                );
              }
              this.$store.modal.close();
            } catch (err) {
              alert("Failed: " + err.message);
            }
          },
        };
      }

      // Device form component
      function deviceForm() {
        return {
          form: {
            id: "",
            type: "light_switch",
            individual_address: "",
            room_id: "",
            group_addresses: {},
          },
          // Help panel state
          showHelp: false,
          helpTab: "all-devices",
          dptSearch: "",
          gaFilter: "",
          
          init() {
            this.$watch("$store.modal.open", (open) => {
              if (open && this.$store.modal.type === "device") {
                // Reset help panel state
                this.showHelp = false;
                this.helpTab = "recommended";
                this.dptSearch = "";
                
                if (
                  this.$store.modal.mode === "edit" &&
                  this.$store.modal.data
                ) {
                  // Deep copy and normalize GA data to object format
                  const normalizedGAs = {};
                  for (const [name, gaData] of Object.entries(
                    this.$store.modal.data.group_addresses || {},
                  )) {
                    if (typeof gaData === "object") {
                      normalizedGAs[name] = { ...gaData };
                    } else {
                      // Convert legacy string format to object
                      normalizedGAs[name] = {
                        ga: gaData,
                        dpt: this.$store.app.guessDPT(
                          name,
                          this.$store.modal.data.type,
                        ),
                        flags: this.$store.app.guessFlags(name),
                      };
                    }
                  }
                  this.form = {
                    ...this.$store.modal.data,
                    group_addresses: normalizedGAs,
                  };
                } else {
                  const template = this.$store.modal.data?.template;
                  // Convert template GAs to editable format
                  const templateGAs = {};
                  if (template?.group_addresses) {
                    for (const [name, gaDef] of Object.entries(
                      template.group_addresses,
                    )) {
                      templateGAs[name] = {
                        ga: "",
                        dpt: gaDef.dpt || "1.001",
                        flags: gaDef.flags || "C-W-U-",
                      };
                    }
                  }
                  this.form = {
                    id: template
                      ? `${template.id}-${Date.now().toString(36)}`
                      : "",
                    type: template?.id || "light_switch",
                    individual_address: "",
                    room_id: "",
                    group_addresses: templateGAs,
                  };
                }
              }
            });
          },
          
          // Update a specific field within a GA object
          updateGA(name, field, value) {
            if (typeof this.form.group_addresses[name] !== "object") {
              // Convert to object if it was a string
              this.form.group_addresses[name] = {
                ga: this.form.group_addresses[name] || "",
                dpt: "",
                flags: "",
              };
            }
            this.form.group_addresses[name][field] = value;
          },
          
          addGA() {
            const name = prompt("Group address name:");
            if (name) {
              this.form.group_addresses[name] = {
                ga: "",
                dpt: "1.001",
                flags: "C-W-U-",
              };
            }
          },
          
          removeGA(name) {
            const newGAs = { ...this.form.group_addresses };
            delete newGAs[name];
            this.form.group_addresses = newGAs;
          },
          
          // Apply recommended GA structure from reference
          applyRecommendedGAs() {
            const template = this.$store.reference.getRecommendedGAs(this.form.type);
            if (!template?.recommended_gas) return;
            
            const newGAs = {};
            for (const ga of template.recommended_gas) {
              newGAs[ga.name] = {
                ga: "",  // User fills in the actual address
                dpt: ga.dpt,
                flags: ga.flags,
              };
            }
            this.form.group_addresses = newGAs;
          },
          
          // Handle device type change - offer to apply recommended structure
          onTypeChange() {
            if (this.$store.modal.mode === "create" && Object.keys(this.form.group_addresses).length === 0) {
              // Auto-show help panel with recommended tab for new devices
              this.showHelp = true;
              this.helpTab = "recommended";
            }
          },
          
          // Copy DPT to clipboard
          copyDpt(dptId) {
            navigator.clipboard?.writeText(dptId) || (() => {
              const ta = document.createElement('textarea');
              ta.value = dptId;
              document.body.appendChild(ta);
              ta.select();
              document.execCommand('copy');
              document.body.removeChild(ta);
            })();
          },
          
          // Get tooltip for a DPT
          getDptTooltip(dptId) {
            if (!dptId) return "Datapoint type (e.g., 1.001 for switch)";
            const dpt = this.$store.reference.dptList.find(d => d.id === dptId);
            if (!dpt) return dptId;
            return `${dpt.name}${dpt.unit ? ' (' + dpt.unit + ')' : ''} - ${dpt.use_case}`;
          },
          
          // Suggest next available IA
          suggestIA() {
            // If we have an existing address, suggest next on same line
            if (this.form.individual_address) {
              const parts = this.form.individual_address.split(".");
              if (parts.length >= 2) {
                this.form.individual_address = this.$store.reference.suggestNextIA(`${parts[0]}.${parts[1]}`);
                return;
              }
            }
            // Otherwise suggest on line 1.1
            this.form.individual_address = this.$store.reference.suggestNextIA("1.1");
          },
          
          // Get hint for IA field
          getIAHint() {
            const used = this.$store.reference.getAllUsedIAs();
            if (used.length === 0) return "No devices yet";
            return `${used.length} addresses in use`;
          },
          
          async submit() {
            try {
              if (this.$store.modal.mode === "create") {
                await this.$store.app.createDevice(this.form);
              } else {
                await this.$store.app.updateDevice(this.form.id, {
                  room_id: this.form.room_id || null,
                  individual_address: this.form.individual_address,
                  group_addresses: this.form.group_addresses,
                });
              }
              this.$store.modal.close();
            } catch (err) {
              alert("Failed: " + err.message);
            }
          },
        };
      }

      // Template browser component
      function templateBrowser() {
        return {
          selectedDomain: null,
          get filteredTemplates() {
            if (!this.selectedDomain) return this.$store.app.templates;
            return this.$store.app.templates.filter(
              (t) => t.domain === this.selectedDomain,
            );
          },
          selectTemplate(template) {
            this.$store.modal.show("device", "create", { template });
          },
        };
      }

      // Device controls component (placeholder for future enhancements)
      function deviceControls() {
        return {};
      }

      // Telegram inspector resizer component
      function telegramResizer() {
        return {
          height:
            parseInt(localStorage.getItem("telegramInspectorHeight")) || 200,
          minHeight: 100,
          maxHeight: window.innerHeight * 0.7,
          startY: 0,
          startHeight: 0,

          startResize(e) {
            this.startY = e.clientY;
            this.startHeight = this.height;

            const onMouseMove = (e) => {
              const delta = this.startY - e.clientY;
              const newHeight = Math.min(
                this.maxHeight,
                Math.max(this.minHeight, this.startHeight + delta),
              );
              this.height = newHeight;
            };

            const onMouseUp = () => {
              document.removeEventListener("mousemove", onMouseMove);
              document.removeEventListener("mouseup", onMouseUp);
              document.body.style.cursor = "";
              document.body.style.userSelect = "";
              // Save to localStorage
              localStorage.setItem(
                "telegramInspectorHeight",
                this.height.toString(),
              );
            };

            document.addEventListener("mousemove", onMouseMove);
            document.addEventListener("mouseup", onMouseUp);
            document.body.style.cursor = "ns-resize";
            document.body.style.userSelect = "none";
          },
        };
      }
    </script>
  </body>
</html>
