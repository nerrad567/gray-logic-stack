# Gray Logic — Development Support Services
#
# These are the services that Gray Logic Core connects TO.
# The Go core itself runs natively on the host for fast iteration (~2-3s rebuild).
#
# Usage:
#   docker compose -f docker-compose.dev.yml up -d        # Start services
#   docker compose -f docker-compose.dev.yml down          # Stop services
#   docker compose -f docker-compose.dev.yml down -v       # Stop + wipe data
#
# Or via Makefile (from code/core):
#   make dev-services        # Start
#   make dev-services-down   # Stop

services:
  # MQTT Broker
  mosquitto:
    image: eclipse-mosquitto:2.0.18
    container_name: graylogic-mosquitto
    ports:
      - "127.0.0.1:1883:1883" # localhost only
    volumes:
      - ./code/core/docker/mosquitto/config:/mosquitto/config
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log
    healthcheck:
      test: ["CMD-SHELL", "mosquitto_sub -t '$$SYS/#' -C 1 -W 3 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Time Series Database
  influxdb:
    image: influxdb:2.7-alpine
    container_name: graylogic-influxdb
    ports:
      - "127.0.0.1:8086:8086" # localhost only
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=graylogic
      - DOCKER_INFLUXDB_INIT_PASSWORD=dev-password-only
      - DOCKER_INFLUXDB_INIT_ORG=graylogic
      - DOCKER_INFLUXDB_INIT_BUCKET=graylogic
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=dev-token-graylogic-influxdb-local
    volumes:
      - influxdb_data:/var/lib/influxdb2

  # KNX/IP Gateway Simulator (standalone Python, UDP:3671, API:9090)
  knxsim:
    build:
      context: ./sim/knxsim
    container_name: graylogic-knxsim
    ports:
      - "127.0.0.1:3671:3671/udp" # KNXnet/IP — Go core connects here
      - "127.0.0.1:9090:9090"     # Web UI
    volumes:
      - knxsim_data:/app/data
      - ./sim/knxsim/static:/app/static
      - ./sim/knxsim/templates:/app/templates
      - ./sim/knxsim/config.yaml:/app/config.yaml
      - ./sim/knxsim/persistence:/app/persistence
      - ./sim/knxsim/api:/app/api
      - ./sim/knxsim/core:/app/core
      - ./sim/knxsim/devices:/app/devices
      - ./sim/knxsim/scenarios:/app/scenarios

volumes:
  mosquitto_data:
  mosquitto_log:
  influxdb_data:
  knxsim_data:
