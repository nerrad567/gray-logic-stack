# Gray Logic — Development Support Services
#
# These are the services that Gray Logic Core connects TO.
# The Go core itself runs natively on the host for fast iteration (~2-3s rebuild).
#
# Usage:
#   docker compose -f docker-compose.dev.yml up -d        # Start services
#   docker compose -f docker-compose.dev.yml down          # Stop services
#   docker compose -f docker-compose.dev.yml down -v       # Stop + wipe data
#
# Or via Makefile (from code/core):
#   make dev-services        # Start
#   make dev-services-down   # Stop

services:
  # MQTT Broker
  mosquitto:
    image: eclipse-mosquitto:2.0.18
    container_name: graylogic-mosquitto
    ports:
      - "127.0.0.1:1883:1883" # localhost only
    volumes:
      - ./code/core/docker/mosquitto/config:/mosquitto/config
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log
    healthcheck:
      test: ["CMD-SHELL", "mosquitto_sub -t '$$SYS/#' -C 1 -W 3 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Time Series Database (VictoriaMetrics — InfluxDB line protocol on /write)
  victoriametrics:
    image: victoriametrics/victoria-metrics:v1.135.0
    container_name: graylogic-victoriametrics
    ports:
      - "127.0.0.1:8428:8428" # localhost only — HTTP API (write + query)
    command:
      - "-storageDataPath=/victoria-metrics-data"
      - "-retentionPeriod=3y"
      - "-httpListenAddr=:8428"
    volumes:
      - victoriametrics_data:/victoria-metrics-data

  # KNX/IP Gateway Simulator (standalone Python, UDP:3671, API:9090)
  knxsim:
    build:
      context: ./sim/knxsim
    container_name: graylogic-knxsim
    ports:
      - "127.0.0.1:3671-3680:3671-3680/udp" # KNXnet/IP — up to 10 premises
      - "127.0.0.1:9090:9090" # Web UI
    volumes:
      - knxsim_data:/app/data
      - ./sim/knxsim/static:/app/static
      - ./sim/knxsim/templates:/app/templates
      - ./sim/knxsim/config.yaml:/app/config.yaml
      - ./sim/knxsim/persistence:/app/persistence
      - ./sim/knxsim/api:/app/api
      - ./sim/knxsim/core:/app/core
      - ./sim/knxsim/devices:/app/devices
      - ./sim/knxsim/scenarios:/app/scenarios

volumes:
  mosquitto_data:
  mosquitto_log:
  victoriametrics_data:
  knxsim_data:
