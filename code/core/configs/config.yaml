# Gray Logic Core Configuration
# ==============================
#
# This is the default configuration file for Gray Logic Core.
# Copy this file to /etc/graylogic/config.yaml and modify as needed.

# ============================================================================
# DEVELOPER MODE
# ============================================================================
# When enabled, device commands apply state changes locally without waiting
# for bridge confirmation. Disable in production to ensure only confirmed
# hardware state is persisted.
dev_mode: true
#
# Configuration can also be set via environment variables:
#   GRAYLOGIC_DATABASE_PATH=/data/graylogic.db
#   GRAYLOGIC_API_PORT=8080
#
# Environment variables take precedence over this file.

# ============================================================================
# SITE INFORMATION
# ============================================================================

site:
  # Unique identifier for this installation
  id: "site-001"

  # Human-readable name
  name: "My Home"

  # Timezone for schedules and astronomical calculations (IANA format)
  timezone: "Europe/London"

  # Location for sunrise/sunset calculations
  location:
    latitude: 51.5074
    longitude: -0.1278

# ============================================================================
# DATABASE
# ============================================================================

database:
  # Path to SQLite database file
  path: "./data/graylogic.db"

  # Enable WAL mode for better concurrent access
  # See: https://sqlite.org/wal.html
  wal_mode: true

  # Maximum time to wait for database lock (seconds)
  busy_timeout: 5

# ============================================================================
# MQTT MESSAGE BUS
# ============================================================================

mqtt:
  # Broker connection details
  broker:
    host: "localhost"
    port: 1883
    # Use TLS for encrypted connection
    tls: false
    # Client ID (must be unique per broker)
    client_id: "graylogic-core"

  # Authentication (leave empty if not required)
  auth:
    username: ""
    password: ""

  # Quality of Service level (0, 1, or 2)
  # QoS 1 = At least once delivery (recommended)
  qos: 1

  # Reconnect settings
  reconnect:
    initial_delay: 1 # seconds
    max_delay: 60 # seconds
    max_attempts: 0 # 0 = unlimited

# ============================================================================
# API SERVER
# ============================================================================

api:
  # HTTP server settings
  host: "0.0.0.0"
  port: 8090

  # TLS configuration (recommended for production)
  tls:
    enabled: false
    cert_file: ""
    key_file: ""

  # Request timeouts
  timeouts:
    read: 30 # seconds
    write: 30 # seconds
    idle: 60 # seconds

  # CORS settings (for web admin)
  cors:
    allowed_origins:
      - "http://localhost:3000"
      - "http://localhost:8888"
      - "http://192.168.4.100:8888"
      - "http://192.168.4.100:8090"
      - "https://admin.local"
    allowed_methods:
      - "GET"
      - "POST"
      - "PUT"
      - "DELETE"
    allowed_headers:
      - "Authorization"
      - "Content-Type"

# ============================================================================
# WEBSOCKET
# ============================================================================

websocket:
  # Path for WebSocket connections
  path: "/ws"

  # Maximum message size (bytes)
  max_message_size: 8192

  # Ping interval to keep connections alive
  ping_interval: 30 # seconds

  # Pong timeout (how long to wait for pong response)
  pong_timeout: 10 # seconds

# ============================================================================
# INFLUXDB (Time-Series Data)
# ============================================================================

influxdb:
  # Enable InfluxDB integration for PHM and energy data
  enabled: false

  # Connection settings
  url: "http://localhost:8086"
  token: "" # Set via GRAYLOGIC_INFLUXDB_TOKEN environment variable
  org: "graylogic"
  bucket: "metrics"

  # Write batch settings
  batch_size: 100
  flush_interval: 10 # seconds

# ============================================================================
# LOGGING
# ============================================================================

logging:
  # Log level: debug, info, warn, error
  level: "debug"

  # Output format: json, text
  format: "json"

  # Output destination: stdout, file
  output: "stdout"

  # If output is "file":
  file:
    path: "./logs/graylogic.log"
    max_size: 100 # megabytes
    max_backups: 5 # number of old files to keep
    max_age: 30 # days
    compress: true

# ============================================================================
# PROTOCOLS (Bridge Configuration)
# ============================================================================

protocols:
  # KNX protocol bridge
  knx:
    enabled: true
    # Path to KNX bridge configuration (devices, group addresses, mappings)
    config_file: "configs/knx-bridge.yaml"
    # knxd connection (used when managed: false or as fallback)
    knxd_host: "localhost"
    knxd_port: 6720

    # knxd Daemon Management
    # ----------------------
    # When managed: true, Gray Logic will spawn and manage knxd as a subprocess.
    # This eliminates the need for engineers to edit /etc/knxd.conf or use sudo.
    knxd:
      # If true, Gray Logic spawns and manages knxd
      # If false, expects knxd to be running externally (e.g., systemd service)
      managed: true

      # Path to knxd executable
      binary: "/usr/bin/knxd"

      # knxd's own address on the KNX bus
      # Format: area.line.device (e.g., "0.0.1")
      physical_address: "0.0.1"

      # Range of addresses knxd can assign to clients
      # Format: area.line.device:count (e.g., "0.0.2:8" = 0.0.2 through 0.0.9)
      client_addresses: "0.0.2:8"

      # Backend connection to the KNX bus
      backend:
        # Connection type: "usb", "ipt" (IP tunnelling), or "ip" (IP routing)
        # TESTING: Using IPT to connect to Windows KNX Virtual
        type: "ipt"

        # IP Tunnelling settings - connects to KNX/IP gateway via KNXnet/IP
        # KNX Virtual on Windows VM
        host: "192.168.4.34"
        port: 3671

        # USB device settings (for type: "usb")
        # These IDs are for Weinzierl KNX-USB Interface
        usb_vendor_id: "0e77"
        usb_product_id: "0104"

        # Enable automatic USB reset before restart attempts
        # This helps recover from LIBUSB_ERROR_BUSY without requiring sudo.
        # Requires: usbreset utility and udev rule granting write access.
        usb_reset_on_retry: true

        # Enable proactive USB reset when bus-level health checks fail.
        # This provides faster recovery for USB interface issues without
        # waiting for the full watchdog restart cycle (3 failures × 30s).
        # Requires: usbreset utility and udev rule granting write access.
        usb_reset_on_bus_failure: true

      # Automatic restart on failure
      restart_on_failure: true
      restart_delay_seconds: 5
      max_restart_attempts: 10

      # Watchdog health check interval
      # knxd is killed and restarted after 3 consecutive health check failures
      health_check_interval: 10s # Shortened for testing (normally 30s)

      # Bus-level health check (optional but recommended)
      # ------------------------------------------------
      # Specify a KNX group address to read during health checks.
      # This verifies end-to-end communication: knxd → interface → bus → device
      #
      # Recommended: Use PSU diagnostic address or any always-responsive device
      # Common PSU addresses: 1/7/0 (status), 1/7/1 (diagnostics)
      # Leave empty to disable bus-level checks (only protocol checks)
      #
      # KNX Virtual demo project - feedback address with Read flag enabled
      # TESTING: Disabled - no physical KNX bus attached to USB interface
      # health_check_device_address: "0/0/3"
      health_check_device_address: ""
      health_check_device_timeout: 2s # Shorter timeout for USB

      # knxd log verbosity (0-9, 0 = minimal)
      log_level: 3

  # DALI lighting protocol bridge
  dali:
    enabled: false
    # Gateway connection details
    gateway_type: "tridonic" # or "helvar", "eldoled", etc.
    gateway_host: "192.168.1.100"
    gateway_port: 502

  # Modbus protocol bridge
  modbus:
    enabled: false
    # For Modbus TCP
    mode: "tcp" # or "rtu"
    tcp_host: "192.168.1.101"
    tcp_port: 502
    # For Modbus RTU (serial)
    rtu_device: "/dev/ttyUSB0"
    rtu_baud: 9600

# ============================================================================
# SECURITY
# ============================================================================

security:
  # JWT token settings
  jwt:
    # Secret key for signing (MUST be changed in production!)
    # Generate with: openssl rand -base64 32
    # Minimum 32 characters required for adequate security.
    secret: "dev-only-secret-CHANGE-IN-PRODUCTION!"
    # Token expiry time
    access_token_ttl: 15 # minutes
    refresh_token_ttl: 1440 # minutes (24 hours)

  # API key settings (for integrations)
  api_keys:
    enabled: false

  # Rate limiting
  rate_limit:
    enabled: true
    requests_per_minute: 100
