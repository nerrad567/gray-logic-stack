# Gray Logic Development Infrastructure
#
# This provides MQTT broker and time-series database for local development.
# Completely isolated from other Docker infrastructure on this host.
#
# Usage:
#   docker compose up -d        # Start services
#   docker compose down         # Stop services
#   docker compose down -v      # Stop and remove volumes (clean slate)
#   docker compose logs -f      # Follow logs
#
# Safety:
#   - All ports bound to 127.0.0.1 (localhost only)
#   - Separate 'graylogic' network (isolated from other Docker networks)
#   - Prefixed container names (graylogic-*)
#   - Named volumes with graylogic_ prefix

name: graylogic

services:
  # ==========================================================================
  # MOSQUITTO - MQTT Broker
  # ==========================================================================
  # Handles device communication via publish/subscribe messaging.
  # Protocol bridges (KNX, DALI, etc.) will connect here.
  #
  # Ports:
  #   1883 - MQTT (unencrypted, localhost only - fine for dev)
  #   9001 - WebSocket (for browser-based debugging tools)
  #
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: graylogic-mosquitto
    restart: unless-stopped
    ports:
      - "127.0.0.1:1883:1883"   # MQTT - localhost only
      - "127.0.0.1:9001:9001"   # WebSocket - localhost only
    volumes:
      - ./docker/mosquitto/config:/mosquitto/config:ro
      - mosquitto-data:/mosquitto/data
      - mosquitto-log:/mosquitto/log
    networks:
      - graylogic
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-t", "$$SYS/#", "-C", "1", "-i", "healthcheck", "-W", "3"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ==========================================================================
  # INFLUXDB - Time-Series Database
  # ==========================================================================
  # Stores metrics for PHM (Predictive Health Monitoring) and energy tracking.
  # High-frequency sensor data with automatic retention policies.
  #
  # Port:
  #   8086 - HTTP API (localhost only)
  #
  # Default credentials (dev only):
  #   Username: admin
  #   Password: graylogic-dev-password
  #   Organisation: graylogic
  #   Bucket: metrics
  #
  influxdb:
    image: influxdb:2
    container_name: graylogic-influxdb
    restart: unless-stopped
    ports:
      - "127.0.0.1:8086:8086"   # HTTP API - localhost only
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=graylogic-dev-password
      - DOCKER_INFLUXDB_INIT_ORG=graylogic
      - DOCKER_INFLUXDB_INIT_BUCKET=metrics
      - DOCKER_INFLUXDB_INIT_RETENTION=30d
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=graylogic-dev-token
    volumes:
      - influxdb-data:/var/lib/influxdb2
      - influxdb-config:/etc/influxdb2
    networks:
      - graylogic
    healthcheck:
      test: ["CMD", "influx", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# ==========================================================================
# NETWORK
# ==========================================================================
# Isolated bridge network for Gray Logic services.
# Containers can reach each other by service name (e.g., 'mosquitto', 'influxdb').
#
networks:
  graylogic:
    name: graylogic
    driver: bridge

# ==========================================================================
# VOLUMES
# ==========================================================================
# Persistent storage for data that survives container restarts.
# All prefixed with 'graylogic_' to avoid conflicts.
#
volumes:
  mosquitto-data:
    name: graylogic_mosquitto-data
  mosquitto-log:
    name: graylogic_mosquitto-log
  influxdb-data:
    name: graylogic_influxdb-data
  influxdb-config:
    name: graylogic_influxdb-config
