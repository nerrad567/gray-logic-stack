{
  "version": "2.0.0",
  "description": "Persistent tracking for /review-all across sessions. Claude MUST read this file at the start of every /review-all invocation.",
  "created": "2026-02-05",
  "last_updated": "2026-02-05",

  "format_changelog": {
    "v2.0.0": "Redesigned review-all to run 6 specialists (added red-team + chaos-audit). Reset sessions for fresh run. Archived v1 results. Fixed 'performance' → 'optimise' naming.",
    "v1.0.0": "Original 4-specialist format (standards, security, performance, stability)"
  },

  "specialists": [
    "standards",
    "security",
    "red-team",
    "optimise",
    "stability",
    "chaos-audit"
  ],

  "codebase_map": {
    "total_packages": 13,
    "total_go_files": 155,
    "total_test_files": 35,
    "total_loc_approx": 23500,
    "packages": {
      "cmd/graylogic": {
        "files": 2,
        "test_files": 1,
        "loc": 400,
        "category": "entrypoint"
      },
      "internal/api": {
        "files": 26,
        "test_files": 3,
        "loc": 3200,
        "category": "api"
      },
      "internal/auth": {
        "files": 19,
        "test_files": 8,
        "loc": 1900,
        "category": "security"
      },
      "internal/device": {
        "files": 21,
        "test_files": 6,
        "loc": 2800,
        "category": "domain"
      },
      "internal/automation": {
        "files": 12,
        "test_files": 5,
        "loc": 1700,
        "category": "domain"
      },
      "internal/bridges/knx": {
        "files": 22,
        "test_files": 7,
        "loc": 4500,
        "category": "protocol"
      },
      "internal/knxd": {
        "files": 4,
        "test_files": 1,
        "loc": 1400,
        "category": "protocol"
      },
      "internal/process": {
        "files": 3,
        "test_files": 1,
        "loc": 850,
        "category": "infrastructure"
      },
      "internal/location": {
        "files": 8,
        "test_files": 2,
        "loc": 1200,
        "category": "domain"
      },
      "internal/commissioning/etsimport": {
        "files": 6,
        "test_files": 1,
        "loc": 2800,
        "category": "commissioning"
      },
      "internal/audit": {
        "files": 1,
        "test_files": 0,
        "loc": 200,
        "category": "infrastructure"
      },
      "internal/infrastructure/database": {
        "files": 5,
        "test_files": 2,
        "loc": 600,
        "category": "infrastructure"
      },
      "internal/infrastructure/logging": {
        "files": 3,
        "test_files": 1,
        "loc": 250,
        "category": "infrastructure"
      },
      "internal/infrastructure/mqtt": {
        "files": 9,
        "test_files": 2,
        "loc": 800,
        "category": "infrastructure"
      },
      "internal/infrastructure/tsdb": {
        "files": 7,
        "test_files": 2,
        "loc": 500,
        "category": "infrastructure"
      },
      "internal/infrastructure/config": {
        "files": 3,
        "test_files": 1,
        "loc": 900,
        "category": "infrastructure"
      },
      "internal/panel": {
        "files": 3,
        "test_files": 1,
        "loc": 350,
        "category": "infrastructure"
      }
    }
  },

  "review_plan": {
    "description": "Systematic full-codebase review in 5 sessions, ordered by risk. Each session runs 6 specialists: standards, security, red-team, optimise, stability, chaos-audit.",
    "sessions": [
      {
        "session": 1,
        "name": "Security Core + Auth Handlers",
        "status": "completed",
        "completed_date": "2026-02-05",
        "packages": [
          "internal/auth",
          "internal/api (auth handlers: auth.go, users.go, panels.go, middleware.go)"
        ],
        "focus": "Auth system deep dive: RBAC, JWT, token lifecycle, password handling, session management. Adversarial auth bypass vectors. Resilience of auth under failures.",
        "estimated_time": "45-60 min",
        "note": "v1 review found 22 findings — all fixed in commit 8adc4e0. v2 re-run with 6 specialists found 5 new findings (0C, 0H, 2M, 3L)."
      },
      {
        "session": 2,
        "name": "API Layer + WebSocket",
        "status": "pending",
        "packages": [
          "internal/api (remaining handlers: devices.go, scenes.go, locations.go, groups.go, zones.go, tags.go, hierarchy.go, state_history.go, discovery.go, commissioning.go, audit.go, metrics.go, system.go, site.go)",
          "internal/api (websocket.go, errors.go, server.go, router.go)"
        ],
        "focus": "All non-auth API handlers, WebSocket hub, error handling, routing, server lifecycle. Adversarial input abuse. WebSocket resilience patterns.",
        "estimated_time": "45-60 min",
        "note": "v1 review found 11 findings (still open). v2 re-run will add red-team and chaos-audit coverage and verify prior findings."
      },
      {
        "session": 3,
        "name": "Domain Logic + State Management",
        "status": "pending",
        "packages": [
          "internal/device",
          "internal/automation",
          "internal/location"
        ],
        "focus": "Device registry, state management, group resolution, scene engine, location hierarchy. Thread safety, cache consistency, data integrity. Adversarial state manipulation. Registry resilience.",
        "estimated_time": "45-60 min"
      },
      {
        "session": 4,
        "name": "Protocol Layer + Subprocess Management",
        "status": "pending",
        "packages": [
          "internal/bridges/knx",
          "internal/knxd",
          "internal/process",
          "internal/commissioning/etsimport"
        ],
        "focus": "KNX bridge, DPT encoding, telegram handling, knxd subprocess, process lifecycle, ETS import. Protocol compliance, fault tolerance, input validation. Bus-level attack vectors. Process crash recovery.",
        "estimated_time": "45-60 min"
      },
      {
        "session": 5,
        "name": "Infrastructure + Integration + Wiring",
        "status": "pending",
        "packages": [
          "internal/infrastructure/database",
          "internal/infrastructure/mqtt",
          "internal/infrastructure/tsdb",
          "internal/infrastructure/config",
          "internal/infrastructure/logging",
          "internal/panel",
          "internal/audit",
          "cmd/graylogic"
        ],
        "focus": "Database layer, MQTT client, TSDB client, config validation, logging, panel serving, audit trail, main.go wiring and shutdown ordering. Cross-cutting integration concerns. Infrastructure failure recovery.",
        "estimated_time": "45-60 min"
      }
    ]
  },

  "completed_reviews": [
    {
      "session": 1,
      "date": "2026-02-05",
      "name": "Security Core + Auth Handlers",
      "packages_reviewed": [
        "internal/auth (10 source files: claims.go, types.go, password.go, permissions.go, seed.go, room_access.go, token_repository.go, user_repository.go, panel_repository.go, doc.go)",
        "internal/api (auth handlers: auth.go, users.go, panels.go, middleware.go)"
      ],
      "loc_reviewed": 3270,
      "specialists_run": [
        "standards",
        "security",
        "red-team",
        "optimise",
        "stability",
        "chaos-audit"
      ],
      "v1_fixes_verified": "All 22 v1 Session 1 findings confirmed fixed (commit 8adc4e0)",
      "findings": {
        "critical": [],
        "high": [],
        "medium": [
          {
            "id": "S1v2-M1",
            "title": "Panel UpdateLastSeen goroutine uses context.Background() — outlives shutdown, races with DB close",
            "files": ["middleware.go:249-252"],
            "found_by": ["security", "stability", "chaos-audit"],
            "status": "open",
            "remediation": "Use server context or 1s timeout context; avoid context.Background() in detached goroutines"
          },
          {
            "id": "S1v2-M2",
            "title": "User deletion doesn't clear user_room_access — orphaned rows remain",
            "files": ["api/users.go:165-169"],
            "found_by": ["red-team", "chaos-audit"],
            "status": "open",
            "remediation": "Add s.roomAccessRepo.ClearRoomAccess(r.Context(), id) before delete, or verify FK ON DELETE CASCADE"
          }
        ],
        "low": [
          {
            "id": "S1v2-L1",
            "title": "No display name length validation on user create",
            "files": ["api/users.go:55"],
            "found_by": ["red-team"],
            "status": "open"
          },
          {
            "id": "S1v2-L2",
            "title": "PermissionsForRole allocates new slice on every call (not on hot path)",
            "files": ["auth/permissions.go:72-78"],
            "found_by": ["optimise"],
            "status": "open"
          },
          {
            "id": "S1v2-L3",
            "title": "No TestResilience_* tests for auth subsystem failure scenarios",
            "files": ["auth package"],
            "found_by": ["chaos-audit"],
            "status": "open"
          }
        ]
      },
      "positive_observations": [
        "All 22 v1 findings properly fixed — excellent remediation quality",
        "Family-based token theft detection with atomic rotation (no TOCTOU race)",
        "Argon2id with OWASP 2025 parameters + constant-time comparison",
        "90-day absolute session lifetime enforcement via family creation timestamp",
        "Compile-time permission model — static map, no DB-backed escalation",
        "In-memory caching for panel auth (30s TTL) and room scope (30s TTL)",
        "Atomic password change + session revocation in single transaction",
        "Password/token hashes never serialised (json:\"-\" on all hash fields)",
        "JWT algorithm pinned to HS256 — prevents algorithm confusion attacks",
        "Rate limiting per TCP IP with X-Forwarded-For intentionally ignored (LAN)",
        "Username format validation (regex, 1-64 chars)",
        "Comprehensive self-protection guards (no self-deactivate/demote/delete)",
        "Owner escalation protection at every entry point",
        "Seed owner race handled via unique constraint, not check-then-act"
      ],
      "scores": {
        "standards": 9.5,
        "security": 9.0,
        "red_team": 9.0,
        "optimise": 9.0,
        "stability": 9.0,
        "chaos_audit": 8.5
      },
      "overall_score": 9.0,
      "status": "complete"
    }
  ],

  "findings_summary": {
    "total_findings": 5,
    "by_severity": { "critical": 0, "high": 0, "medium": 2, "low": 3 },
    "by_specialist": {
      "standards": 0,
      "security": 1,
      "red-team": 3,
      "optimise": 1,
      "stability": 1,
      "chaos-audit": 3
    },
    "fixed": 0,
    "accepted": 0,
    "deferred": 0
  },

  "archived_runs": {
    "description": "Previous review results from v1.0.0 format (4 specialists only). Preserved for reference. Session 1 findings were all fixed in commit 8adc4e0.",
    "v1_sessions": [
      {
        "session": 1,
        "date": "2026-02-05",
        "name": "Latest Changes + Security Core",
        "specialists_run": ["standards", "security", "optimise", "stability"],
        "findings_count": { "critical": 2, "high": 5, "medium": 11, "low": 4 },
        "total": 22,
        "fix_status": "all_fixed",
        "fix_commit": "8adc4e0",
        "fix_commit_message": "fix: implement all 22 Session 1 review-all findings"
      },
      {
        "session": 2,
        "date": "2026-02-05",
        "name": "API Layer + WebSocket",
        "specialists_run": ["standards", "security", "optimise", "stability"],
        "findings_count": { "critical": 0, "high": 1, "medium": 7, "low": 3 },
        "total": 11,
        "fix_status": "open",
        "note": "These findings have not yet been fixed. The v2 re-run will verify and consolidate with new red-team + chaos-audit findings."
      }
    ]
  }
}
